<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成长动态</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .user-name-section {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .user-name-input {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            min-width: 200px;
        }

        .update-name-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .update-name-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
            transition: opacity 0.3s ease;
            line-height: 1.2;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .header h1 #userNameDisplay {
            display: inline;
        }

        .header h1:hover {
            opacity: 0.8;
        }

        .header h1:hover::after {
            content: " (点击修改姓名)";
            font-size: 0.4em;
            opacity: 0.7;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            white-space: nowrap;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            text-align: center;
            margin: 0 auto;
            max-width: 100%;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 140px);
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            padding: 25px 15px;
            border-right: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .content-area {
            flex: 1;
            padding: 25px;
            overflow-x: auto;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: white;
            border: none;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            color: #495057;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-item:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .module h2 {
            color: #495057;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 300;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e9ecef;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .rating-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .emotion-btn {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .emotion-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .emotion-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .dashboard-preview {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .summary-card h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #495057;
        }

        .reading-quotes {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }

        .quote-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .quote-text {
            font-style: italic;
            color: #495057;
            margin-bottom: 5px;
        }

        .quote-reflection {
            font-size: 0.9em;
            color: #6c757d;
        }

        .export-section {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .export-buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .export-btn {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4);
            background: linear-gradient(135deg, #5f3dc4 0%, #9775fa 100%);
        }

        /* 学习主题标签样式 */
        .study-topics-container {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border-radius: 15px;
            border: 2px solid #e8ecff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .topic-input-wrapper {
            display: flex;
            gap: 12px;
            margin-bottom: 18px;
            align-items: center;
        }

        .topic-input-wrapper input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .topic-input-wrapper input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .add-topic-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .add-topic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .add-topic-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #bbb 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .topic-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            min-height: 50px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 2px solid #f0f0f0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 18px;
        }

        .topic-tag {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            gap: 8px;
            animation: slideIn 0.3s ease;
        }

        .topic-tag .topic-name {
            font-weight: 500;
        }

        .topic-tag .topic-time-input {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .topic-tag .topic-time-input input {
            background: transparent;
            border: none;
            color: white;
            width: 40px;
            font-size: 12px;
            text-align: center;
            padding: 0;
        }

        .topic-tag .topic-time-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .topic-tag .topic-time-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .topic-tag .topic-time-input .time-unit {
            font-size: 11px;
            opacity: 0.9;
        }

        .topic-tag .remove-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .topic-tag .remove-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .duration-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 18px;
        }

        .duration-wrapper label {
            font-weight: 600;
            color: #333;
            min-width: 140px;
            font-size: 14px;
        }

        .duration-wrapper input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .duration-wrapper input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .distribute-time-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        .distribute-time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .time-status {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            border-radius: 10px;
            font-size: 14px;
            color: #1976d2;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 图片上传样式 */
        .image-upload-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
            border: 2px dashed #667eea;
        }

        .image-upload-label {
            display: block;
            text-align: center;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .image-upload-label:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .image-upload-input {
            display: none;
        }

        .image-preview {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .image-item {
            position: relative;
            width: 100px;
            height: 120px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-item:hover {
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .image-description-preview {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px;
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-remove:hover {
            background: rgba(255, 0, 0, 1);
        }

        /* 今日记录样式 */
        .today-records-section {
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border-radius: 15px;
            border: 1px solid #e0e8ff;
        }

        .today-records-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .today-records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .record-category {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .record-category h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .record-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .record-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #28a745;
            font-size: 14px;
            line-height: 1.4;
        }

        .record-item:last-child {
            margin-bottom: 0;
        }

        .record-time {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        .no-records {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* 模块导出按钮样式 */
        .module-export-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .module-export-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .export-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .export-btn {
            padding: 8px 12px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            text-align: center;
        }

        .export-btn:hover {
            background: #007bff;
            color: white;
        }

        /* 时间范围选择器样式 */
        .time-range-selector {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .time-range-selector label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .time-range-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            color: #495057;
        }

        .time-range-selector select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* 手机端优化 */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
                display: flex;
                overflow-x: auto;
                gap: 10px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .today-records-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .record-category {
                padding: 15px;
            }
            
            .export-buttons-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .export-btn {
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        @media (max-width: 768px) {
            .nav-item {
                min-width: 120px;
                margin-bottom: 0;
                text-align: center;
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .container {
                margin: 0;
                border-radius: 0;
            }

            .content-area {
                padding: 20px 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .form-control {
                font-size: 16px; /* 防止iOS缩放 */
            }

            .rating-group {
                flex-wrap: wrap;
                gap: 8px;
            }

            .rating-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .emotion-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .emotion-btn {
                padding: 12px 8px;
                font-size: 12px;
            }

            .data-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 1em;
            }

            .summary-card .value {
                font-size: 1.5em;
            }

            .chart-container {
                height: 250px;
            }

            .export-btn {
                padding: 12px 20px;
                font-size: 14px;
                margin: 5px;
                display: block;
                width: 100%;
            }

            .image-item {
                width: 80px;
                height: 80px;
            }

            .image-upload-label {
                padding: 15px;
                font-size: 14px;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .sidebar {
                padding: 15px 10px;
            }

            .nav-item {
                min-width: 100px;
                font-size: 12px;
                padding: 10px 12px;
            }

            .content-area {
                padding: 15px 10px;
            }

            .data-summary {
                grid-template-columns: 1fr;
            }

            .rating-group {
                justify-content: center;
            }

            .emotion-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 图片模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .image-modal-content {
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .image-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }

        .image-display {
            text-align: center;
        }

        .image-display img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .image-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-group textarea,
        .form-group input[type="text"] {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            resize: vertical;
        }

        .form-group textarea:focus,
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .timestamp {
            color: #6c757d;
            font-size: 14px;
            padding: 8px 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px 25px;
            border-top: 1px solid #f0f0f0;
            background: #f8f9fa;
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* 响应式设计 */
         @media (max-width: 768px) {
             .image-detail-container {
                 grid-template-columns: 1fr;
                 gap: 20px;
             }

             .modal-content {
                 width: 95%;
                 margin: 10px;
             }

             .modal-header,
             .modal-body,
             .modal-footer {
                 padding: 15px 20px;
             }
         }

         /* 时间轴样式 */
         .timeline-controls {
             background: white;
             padding: 25px;
             border-radius: 15px;
             box-shadow: 0 3px 10px rgba(0,0,0,0.08);
             margin-bottom: 25px;
         }

         .timeline-filters {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
             gap: 20px;
             margin-bottom: 20px;
         }

         .filter-group {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .filter-group label {
             font-weight: 600;
             color: #495057;
             font-size: 14px;
         }

         .timeline-stats {
             display: flex;
             gap: 30px;
             padding-top: 20px;
             border-top: 1px solid #e9ecef;
         }

         .stat-item {
             display: flex;
             align-items: center;
             gap: 8px;
         }

         .stat-label {
             color: #6c757d;
             font-size: 14px;
         }

         .stat-value {
             font-weight: 600;
             color: #667eea;
             font-size: 16px;
         }

         .timeline-container {
             background: white;
             border-radius: 15px;
             box-shadow: 0 3px 10px rgba(0,0,0,0.08);
             overflow: hidden;
         }

         .timeline-content {
             padding: 25px;
         }

         .timeline-empty {
             text-align: center;
             padding: 60px 20px;
             color: #6c757d;
         }

         .empty-icon {
             font-size: 4em;
             margin-bottom: 20px;
             opacity: 0.5;
         }

         .timeline-empty h3 {
             margin-bottom: 10px;
             color: #495057;
         }

         .timeline-item {
             display: flex;
             margin-bottom: 30px;
             position: relative;
         }

         .timeline-item:last-child {
             margin-bottom: 0;
         }

         .timeline-item::before {
             content: '';
             position: absolute;
             left: 20px;
             top: 50px;
             bottom: -30px;
             width: 2px;
             background: linear-gradient(to bottom, #667eea, #764ba2);
         }

         .timeline-item:last-child::before {
             display: none;
         }

         .timeline-date {
             flex-shrink: 0;
             width: 120px;
             text-align: center;
             padding: 15px 10px;
         }

         .timeline-date-circle {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: 600;
             font-size: 14px;
             margin: 0 auto 10px;
             box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
         }

         .timeline-date-text {
             font-size: 12px;
             color: #6c757d;
             font-weight: 500;
         }

         .timeline-content-wrapper {
             flex: 1;
             margin-left: 30px;
         }

         .timeline-images {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
             gap: 15px;
         }

         .timeline-image-item {
             position: relative;
             border-radius: 10px;
             overflow: hidden;
             box-shadow: 0 3px 10px rgba(0,0,0,0.1);
             transition: transform 0.3s ease;
             cursor: pointer;
         }

         .timeline-image-item:hover {
             transform: translateY(-3px);
             box-shadow: 0 6px 20px rgba(0,0,0,0.15);
         }

         .timeline-image-item img {
             width: 100%;
             height: 120px;
             object-fit: cover;
         }

         .timeline-image-overlay {
             position: absolute;
             bottom: 0;
             left: 0;
             right: 0;
             background: linear-gradient(transparent, rgba(0,0,0,0.7));
             color: white;
             padding: 10px 8px 8px;
             font-size: 12px;
         }

         .timeline-image-module {
             font-weight: 600;
             margin-bottom: 2px;
         }

         .timeline-image-desc {
             opacity: 0.9;
             line-height: 1.3;
             display: -webkit-box;
             -webkit-line-clamp: 2;
             -webkit-box-orient: vertical;
             overflow: hidden;
         }

         .timeline-image-tags {
             margin-top: 5px;
         }

         .timeline-tag {
             display: inline-block;
             background: rgba(255,255,255,0.2);
             padding: 2px 6px;
             border-radius: 10px;
             font-size: 10px;
             margin-right: 4px;
         }

         /* 时间轴响应式设计 */
         @media (max-width: 768px) {
             .timeline-filters {
                 grid-template-columns: 1fr;
                 gap: 15px;
             }

             .timeline-stats {
                 flex-direction: column;
                 gap: 10px;
             }

             .timeline-item {
                 flex-direction: column;
                 margin-bottom: 25px;
             }

             .timeline-item::before {
                 display: none;
             }

             .timeline-date {
                 width: 100%;
                 margin-bottom: 15px;
             }

             .timeline-content-wrapper {
                 margin-left: 0;
             }

             .timeline-images {
                 grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                 gap: 10px;
             }

             .timeline-image-item img {
                 height: 100px;
             }
         }

         /* 标签系统样式 */
         .tag-input-container {
             position: relative;
         }

         .tag-suggestions {
             position: absolute;
             top: 100%;
             left: 0;
             right: 0;
             background: white;
             border: 1px solid #ddd;
             border-radius: 4px;
             max-height: 150px;
             overflow-y: auto;
             z-index: 1000;
             display: none;
         }

         .tag-suggestion-item {
             padding: 8px 12px;
             cursor: pointer;
             border-bottom: 1px solid #f0f0f0;
         }

         .tag-suggestion-item:hover {
             background-color: #f5f5f5;
         }

         .tag-suggestion-item:last-child {
             border-bottom: none;
         }

         .current-tags {
             margin-top: 10px;
             display: flex;
             flex-wrap: wrap;
             gap: 6px;
         }

         .tag-item {
             display: inline-flex;
             align-items: center;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 12px;
             gap: 4px;
         }

         .tag-remove {
             cursor: pointer;
             font-weight: bold;
             opacity: 0.8;
         }

         .tag-remove:hover {
             opacity: 1;
         }

         .popular-tags {
             margin-top: 10px;
         }

         .popular-tags-label {
             font-size: 12px;
             color: #666;
             margin-bottom: 5px;
             display: block;
         }

         .popular-tags-list {
             display: flex;
             flex-wrap: wrap;
             gap: 4px;
         }

         .popular-tag {
             background: #f0f0f0;
             color: #333;
             padding: 3px 8px;
             border-radius: 10px;
             font-size: 11px;
             cursor: pointer;
             border: 1px solid transparent;
             transition: all 0.2s;
         }

         .popular-tag:hover {
             background: #e0e0e0;
             border-color: #ccc;
         }

         .timeline-tag {
             background: rgba(255, 255, 255, 0.9);
             color: #333;
             padding: 2px 6px;
             border-radius: 8px;
             font-size: 10px;
             margin-right: 4px;
         }

         /* 标签管理面板样式 */
         .tag-management-panel {
             background: white;
             border-radius: 8px;
             padding: 20px;
             margin-bottom: 20px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.1);
         }

         .tag-stats {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
             gap: 15px;
             margin-bottom: 20px;
         }

         .tag-stat-item {
             text-align: center;
             padding: 15px;
             background: white;
             color: #333;
             border-radius: 8px;
             border: 1px solid #e9ecef;
         }

         .tag-stat-number {
             font-size: 24px;
             font-weight: bold;
             display: block;
         }

         .tag-stat-label {
             font-size: 12px;
             opacity: 0.9;
         }

         .tag-cloud {
             display: flex;
             flex-wrap: wrap;
             gap: 8px;
             align-items: center;
         }

         .tag-cloud-item {
             background: #F5DEB3;
             color: #8B4513;
             padding: 6px 12px;
             border-radius: 15px;
             font-size: 13px;
             cursor: pointer;
             transition: all 0.3s;
             position: relative;
         }

         .tag-cloud-item:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.2);
         }

         .tag-cloud-item .tag-count {
             background: rgba(139,69,19,0.2);
             padding: 2px 6px;
             border-radius: 8px;
             font-size: 10px;
             margin-left: 6px;
         }

         /* 图片统计面板样式 */
         .image-stats {
             background: white;
             color: #333;
             border: 1px solid #e9ecef;
         }

         .image-growth-panel {
             background: white;
             border-radius: 12px;
             padding: 25px;
             margin: 20px 0;
             box-shadow: 0 4px 20px rgba(0,0,0,0.1);
         }

         .image-growth-panel h3 {
             color: #333;
             margin-bottom: 20px;
             font-size: 18px;
             display: flex;
             align-items: center;
             gap: 8px;
         }

         .image-stats-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 20px;
         }

         .image-stat-card {
             background: #f8f9fa;
             border-radius: 8px;
             padding: 20px;
             border-left: 4px solid #667eea;
         }

         .image-stat-card h4 {
             color: #333;
             margin-bottom: 15px;
             font-size: 14px;
             font-weight: 600;
         }

         .module-distribution {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .module-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 8px 12px;
             background: white;
             border-radius: 6px;
             border-left: 3px solid #667eea;
         }

         .module-name {
             font-size: 13px;
             color: #555;
         }

         .module-count {
             font-weight: bold;
             color: #667eea;
         }

         .monthly-trend {
             display: flex;
             flex-direction: column;
             gap: 6px;
         }

         .trend-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 6px 10px;
             background: white;
             border-radius: 4px;
             font-size: 12px;
         }

         .trend-month {
             color: #666;
         }

         .trend-count {
             font-weight: bold;
             color: #28a745;
         }

         .top-tags-list {
             display: flex;
             flex-direction: column;
             gap: 6px;
         }

         .top-tag-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 8px 12px;
             background: white;
             border-radius: 6px;
             cursor: pointer;
             transition: all 0.2s;
         }

         .top-tag-item:hover {
             background: #e9ecef;
             transform: translateX(2px);
         }

         .tag-name {
             font-size: 13px;
             color: #555;
         }

         .tag-usage-count {
             background: #667eea;
             color: white;
             padding: 2px 8px;
             border-radius: 10px;
             font-size: 11px;
             font-weight: bold;
         }

         .time-distribution {
             display: grid;
             grid-template-columns: repeat(4, 1fr);
             gap: 8px;
         }

         .time-slot {
             text-align: center;
             padding: 10px 5px;
             background: white;
             border-radius: 6px;
             font-size: 11px;
         }

         .time-label {
             color: #666;
             margin-bottom: 4px;
         }

         .time-count {
             font-weight: bold;
             color: #667eea;
             font-size: 14px;
         }

         @media (max-width: 768px) {
             .image-stats-grid {
                 grid-template-columns: 1fr;
             }
             
             .time-distribution {
                 grid-template-columns: repeat(2, 1fr);
             }
         }

         /* ==================== 年度总结样式 ==================== */
         .annual-summary-report {
             max-width: 800px;
             margin: 0 auto;
             padding: 20px;
             background: white;
             border-radius: 15px;
             box-shadow: 0 4px 20px rgba(0,0,0,0.1);
         }

         .summary-header {
             text-align: center;
             margin-bottom: 40px;
             padding: 30px 20px;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             border-radius: 15px;
             color: white;
         }

         .summary-header h3 {
             font-size: 28px;
             margin-bottom: 10px;
             font-weight: bold;
         }

         .summary-subtitle {
             font-size: 16px;
             opacity: 0.9;
             margin: 0;
         }

         .summary-section {
             margin-bottom: 40px;
             padding: 25px;
             background: #f8f9ff;
             border-radius: 12px;
             border-left: 4px solid #667eea;
         }

         .summary-section h4 {
             color: #333;
             margin-bottom: 20px;
             font-size: 20px;
             display: flex;
             align-items: center;
             gap: 8px;
         }

         .keywords-cloud {
             display: flex;
             flex-wrap: wrap;
             gap: 12px;
             margin-bottom: 15px;
         }

         .keyword-tag {
             background: linear-gradient(135deg, #667eea, #764ba2);
             color: white;
             padding: 8px 16px;
             border-radius: 20px;
             font-weight: bold;
             transition: all 0.3s ease;
             cursor: pointer;
         }

         .keyword-tag:hover {
             transform: translateY(-2px);
             box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
         }

         .keywords-insight {
             color: #666;
             font-style: italic;
             margin: 0;
         }

         .stats-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
             gap: 20px;
         }

         .stat-card {
             background: white;
             padding: 20px;
             border-radius: 12px;
             text-align: center;
             box-shadow: 0 2px 10px rgba(0,0,0,0.1);
             transition: all 0.3s ease;
         }

         .stat-card:hover {
             transform: translateY(-5px);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
         }

         .stat-number {
             font-size: 32px;
             font-weight: bold;
             color: #667eea;
             margin-bottom: 8px;
         }

         .stat-label {
             color: #666;
             font-size: 14px;
         }

         .growth-timeline {
             position: relative;
         }

         .milestone {
             display: flex;
             align-items: flex-start;
             margin-bottom: 25px;
             position: relative;
         }

         .milestone:not(:last-child)::after {
             content: '';
             position: absolute;
             left: 30px;
             top: 60px;
             width: 2px;
             height: 40px;
             background: #e9ecef;
         }

         .milestone-date {
             background: #667eea;
             color: white;
             padding: 8px 12px;
             border-radius: 20px;
             font-size: 14px;
             font-weight: bold;
             min-width: 60px;
             text-align: center;
             margin-right: 20px;
         }

         .milestone-content {
             flex: 1;
             background: white;
             padding: 15px 20px;
             border-radius: 10px;
             box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         }

         .milestone-content h5 {
             color: #333;
             margin-bottom: 8px;
             font-size: 16px;
         }

         .milestone-content p {
             color: #666;
             margin: 0;
             font-size: 14px;
         }

         .achievements-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
             gap: 20px;
         }

         .achievement-card {
             background: white;
             padding: 20px;
             border-radius: 12px;
             text-align: center;
             transition: all 0.3s ease;
             border: 2px solid #e9ecef;
         }

         .achievement-card.unlocked {
             border-color: #28a745;
             background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
             color: white;
             transform: scale(1.02);
         }

         .achievement-card.locked {
             opacity: 0.6;
             filter: grayscale(50%);
         }

         .achievement-icon {
             font-size: 40px;
             margin-bottom: 10px;
         }

         .achievement-title {
             font-weight: bold;
             margin-bottom: 8px;
             font-size: 16px;
         }

         .achievement-desc {
             font-size: 12px;
             opacity: 0.9;
         }

         .annual-message {
             background: white;
             padding: 25px;
             border-radius: 12px;
             border-left: 4px solid #ffc107;
             box-shadow: 0 2px 10px rgba(0,0,0,0.1);
         }

         .annual-message p {
             font-size: 16px;
             line-height: 1.6;
             color: #333;
             margin: 0;
             font-style: italic;
         }

         .summary-placeholder {
             text-align: center;
             padding: 60px 20px;
             color: #999;
         }

         .summary-placeholder h4 {
             margin-bottom: 15px;
             color: #666;
         }

         @media (max-width: 768px) {
             .annual-summary-report {
                 margin: 10px;
                 padding: 15px;
             }

             .summary-header {
                 padding: 20px 15px;
             }

             .summary-header h3 {
                 font-size: 24px;
             }

             .summary-section {
                 padding: 20px 15px;
             }

             .stats-grid {
                 grid-template-columns: repeat(2, 1fr);
             }

             .achievements-grid {
                 grid-template-columns: 1fr;
             }

             .milestone {
                 flex-direction: column;
                 align-items: stretch;
             }

             .milestone-date {
                 margin-right: 0;
                 margin-bottom: 10px;
                 align-self: flex-start;
             }
         }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-name-section" id="userNameSection" style="display: none;">
                <input type="text" id="userName" placeholder="请输入您的姓名" class="user-name-input">
                <button onclick="updateUserName()" class="update-name-btn">确认</button>
            </div>
            <h1 id="mainTitle" onclick="toggleUserNameSection()" style="cursor: pointer;">
                🌱 <span id="userNameDisplay">您的</span>成长动态
            </h1>
            <p id="dailyQuote">记录每一天的成长轨迹，让进步看得见</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <button class="nav-item" onclick="showModule('plan')">📅 明日计划</button>
                <button class="nav-item" onclick="showModule('exercise')">🏃‍♂️ 运动记录</button>
                <button class="nav-item" onclick="showModule('study')">📚 学习内容</button>
                <button class="nav-item" onclick="showModule('reading')">📖 阅读感悟</button>
                <button class="nav-item" onclick="showModule('emotion')">😊 情绪状态</button>
                <button class="nav-item" onclick="showModule('timeline')">📸 图片时间轴</button>
                <button class="nav-item" onclick="showModule('dashboard')">📊 数据面板</button>
                <button class="nav-item" onclick="showModule('annual-summary')">🎊 年度总结</button>
            </div>
            
            <div class="content-area">
                <!-- 计划模块 -->
                <div id="plan" class="module active">
                    <h2>📅 明日计划</h2>
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="planDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>主要目标 (1-3个)</label>
                        <textarea id="mainGoals" class="form-control" placeholder="例如：完成项目报告、锻炼30分钟、阅读20页"></textarea>
                    </div>
                    <div class="form-group">
                        <label>具体安排</label>
                        <textarea id="detailPlan" class="form-control" placeholder="详细的时间安排和具体任务"></textarea>
                    </div>
                    <div class="form-group">
                        <label>期望完成度</label>
                        <div class="rating-group">
                            <span>目标完成度：</span>
                            <div id="planRating">
                                <button class="rating-btn" onclick="setRating('plan', 1)">1</button>
                                <button class="rating-btn" onclick="setRating('plan', 2)">2</button>
                                <button class="rating-btn" onclick="setRating('plan', 3)">3</button>
                                <button class="rating-btn" onclick="setRating('plan', 4)">4</button>
                                <button class="rating-btn" onclick="setRating('plan', 5)">5</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图片上传区域 -->
                    <div class="image-upload-section">
                        <label for="plan-image" class="image-upload-label">
                            📷 点击上传相关图片
                        </label>
                        <input type="file" id="plan-image" class="image-upload-input" accept="image/*" multiple>
                        <div id="plan-image-preview" class="image-preview"></div>
                    </div>
                    
                    <button class="btn-primary" onclick="savePlanData()">保存计划</button>
                    
                    <!-- 导出按钮 -->
                    <div class="module-export-section">
                        <h4>📤 导出计划</h4>
                        <div class="time-range-selector">
                            <label>时间范围：</label>
                            <select id="planTimeRange" class="form-control">
                                <option value="1">最近1天</option>
                                <option value="7">最近1周</option>
                                <option value="30">最近1个月</option>
                                <option value="90">最近3个月</option>
                                <option value="180">最近6个月</option>
                                <option value="365">最近1年</option>
                                <option value="all" selected>所有时间</option>
                            </select>
                        </div>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportModuleData('plan', 'smart')">📝 智能整理</button>
                            <button class="export-btn" onclick="exportModuleData('plan', 'json')">📄 JSON格式</button>
                            <button class="export-btn" onclick="exportModuleData('plan', 'csv')">📊 CSV格式</button>
                            <button class="export-btn" onclick="exportModuleData('plan', 'txt')">📝 文本格式</button>
                        </div>
                    </div>
                </div>

                <!-- 运动模块 -->
                <div id="exercise" class="module">
                    <h2>🏃‍♂️ 运动记录</h2>
                    <div class="form-group">
                        <label>运动类型</label>
                        <select id="exerciseTypeSelect" class="form-control" onchange="handleExerciseTypeChange()">
                            <option value="">请选择运动类型</option>
                            <option value="跑步">🏃‍♂️ 跑步</option>
                            <option value="健身房">💪 健身房</option>
                            <option value="瑜伽">🧘‍♀️ 瑜伽</option>
                            <option value="游泳">🏊‍♂️ 游泳</option>
                            <option value="骑行">🚴‍♂️ 骑行</option>
                            <option value="篮球">🏀 篮球</option>
                            <option value="足球">⚽ 足球</option>
                            <option value="羽毛球">🏸 羽毛球</option>
                            <option value="乒乓球">🏓 乒乓球</option>
                            <option value="网球">🎾 网球</option>
                            <option value="爬山">🏔️ 爬山</option>
                            <option value="散步">🚶‍♂️ 散步</option>
                            <option value="舞蹈">💃 舞蹈</option>
                            <option value="普拉提">🤸‍♀️ 普拉提</option>
                            <option value="其他">✏️ 其他（自定义）</option>
                        </select>
                        <input type="text" id="exerciseType" class="form-control" placeholder="请输入自定义运动类型" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>运动时长 (分钟)</label>
                        <input type="number" id="exerciseDuration" class="form-control" placeholder="30">
                    </div>
                    <div class="form-group">
                        <label>运动强度</label>
                        <div class="rating-group">
                            <span>强度评分：</span>
                            <div id="exerciseIntensity">
                                <button class="rating-btn" onclick="setRating('exerciseIntensity', 1)">1</button>
                                <button class="rating-btn" onclick="setRating('exerciseIntensity', 2)">2</button>
                                <button class="rating-btn" onclick="setRating('exerciseIntensity', 3)">3</button>
                                <button class="rating-btn" onclick="setRating('exerciseIntensity', 4)">4</button>
                                <button class="rating-btn" onclick="setRating('exerciseIntensity', 5)">5</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>运动感受</label>
                        <textarea id="exerciseFeeling" class="form-control" placeholder="运动后的感受和体验"></textarea>
                    </div>

                    <!-- 图片上传区域 -->
                    <div class="image-upload-section">
                        <label for="exercise-image" class="image-upload-label">
                            📷 点击上传运动图片
                        </label>
                        <input type="file" id="exercise-image" class="image-upload-input" accept="image/*" multiple>
                        <div id="exercise-image-preview" class="image-preview"></div>
                    </div>

                    <button class="btn-primary" onclick="saveExerciseData()">保存运动记录</button>
                    
                    <!-- 导出按钮 -->
                    <div class="module-export-section">
                        <h4>📤 导出运动记录</h4>
                        <div class="time-range-selector">
                            <label>时间范围：</label>
                            <select id="exerciseTimeRange" class="form-control">
                                <option value="1">最近1天</option>
                                <option value="7">最近1周</option>
                                <option value="30">最近1个月</option>
                                <option value="90">最近3个月</option>
                                <option value="180">最近6个月</option>
                                <option value="365">最近1年</option>
                                <option value="all" selected>所有时间</option>
                            </select>
                        </div>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportModuleData('exercise', 'smart')">📝 智能整理</button>
                            <button class="export-btn" onclick="exportModuleData('exercise', 'json')">📄 JSON格式</button>
                            <button class="export-btn" onclick="exportModuleData('exercise', 'csv')">📊 CSV格式</button>
                            <button class="export-btn" onclick="exportModuleData('exercise', 'txt')">📝 文本格式</button>
                        </div>
                    </div>
                </div>

                <!-- 学习模块 -->
                <div id="study" class="module">
                    <h2>📚 学习内容</h2>
                    <div class="form-group">
                        <label>学习主题</label>
                        <div class="study-topics-container">
                            <div class="topic-input-wrapper">
                                <input type="text" id="newStudyTopic" class="form-control" placeholder="输入学习主题，如：JavaScript">
                                <button type="button" class="add-topic-btn" onclick="addStudyTopic()">添加</button>
                            </div>
                            <div id="studyTopicTags" class="topic-tags-container"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>总学习时长汇总</label>
                        <div class="duration-summary">
                            <div id="totalStudyTime" class="time-display">
                                <span class="time-minutes">0分钟</span>
                                <span class="time-hours">(0小时)</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>学习内容</label>
                        <textarea id="studyContent" class="form-control" placeholder="今天学习的具体内容"></textarea>
                    </div>
                    <div class="form-group">
                        <label>掌握程度</label>
                        <div class="rating-group">
                            <span>掌握评分：</span>
                            <div id="studyMastery">
                                <button class="rating-btn" onclick="setRating('studyMastery', 1)">1</button>
                                <button class="rating-btn" onclick="setRating('studyMastery', 2)">2</button>
                                <button class="rating-btn" onclick="setRating('studyMastery', 3)">3</button>
                                <button class="rating-btn" onclick="setRating('studyMastery', 4)">4</button>
                                <button class="rating-btn" onclick="setRating('studyMastery', 5)">5</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>学习收获</label>
                        <textarea id="studyGains" class="form-control" placeholder="今天的学习收获和心得"></textarea>
                    </div>

                    <!-- 图片上传区域 -->
                    <div class="image-upload-section">
                        <label for="study-image" class="image-upload-label">
                            📷 点击上传学习图片
                        </label>
                        <input type="file" id="study-image" class="image-upload-input" accept="image/*" multiple>
                        <div id="study-image-preview" class="image-preview"></div>
                    </div>

                    <button class="btn-primary" onclick="saveStudyData()">保存学习记录</button>
                    
                    <!-- 导出按钮 -->
                    <div class="module-export-section">
                        <h4>📤 导出学习记录</h4>
                        <div class="time-range-selector">
                            <label>时间范围：</label>
                            <select id="studyTimeRange" class="form-control">
                                <option value="1">最近1天</option>
                                <option value="7">最近1周</option>
                                <option value="30">最近1个月</option>
                                <option value="90">最近3个月</option>
                                <option value="180">最近6个月</option>
                                <option value="365">最近1年</option>
                                <option value="all" selected>所有时间</option>
                            </select>
                        </div>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportModuleData('study', 'smart')">📝 智能整理</button>
                            <button class="export-btn" onclick="exportModuleData('study', 'json')">📄 JSON格式</button>
                            <button class="export-btn" onclick="exportModuleData('study', 'csv')">📊 CSV格式</button>
                            <button class="export-btn" onclick="exportModuleData('study', 'txt')">📝 文本格式</button>
                        </div>
                    </div>
                </div>

                <!-- 阅读模块 -->
                <div id="reading" class="module">
                    <h2>📖 阅读感悟</h2>
                    <div class="form-group">
                        <label>书籍/文章名称</label>
                        <input type="text" id="readingTitle" class="form-control" placeholder="今天阅读的书籍或文章">
                    </div>
                    <div class="form-group">
                        <label>阅读页数/时长</label>
                        <input type="text" id="readingProgress" class="form-control" placeholder="例如：20页 或 30分钟">
                    </div>
                    <div class="form-group">
                        <label>摘录句子</label>
                        <textarea id="readingQuotes" class="form-control" placeholder="摘录印象深刻的句子或段落"></textarea>
                        <button type="button" class="btn-primary" onclick="addQuote()">添加摘录</button>
                    </div>
                    <div id="quotesContainer" class="reading-quotes"></div>
                    <div class="form-group">
                        <label>阅读感悟</label>
                        <textarea id="readingReflection" class="form-control" placeholder="今天阅读的感悟和思考"></textarea>
                    </div>
                    <div class="form-group">
                        <label>推荐指数</label>
                        <div class="rating-group">
                            <span>推荐评分：</span>
                            <div id="readingRating">
                                <button class="rating-btn" onclick="setRating('readingRating', 1)">1</button>
                                <button class="rating-btn" onclick="setRating('readingRating', 2)">2</button>
                                <button class="rating-btn" onclick="setRating('readingRating', 3)">3</button>
                                <button class="rating-btn" onclick="setRating('readingRating', 4)">4</button>
                                <button class="rating-btn" onclick="setRating('readingRating', 5)">5</button>
                            </div>
                        </div>
                    </div>

                    <!-- 图片上传区域 -->
                    <div class="image-upload-section">
                        <label for="reading-image" class="image-upload-label">
                            📷 点击上传阅读图片
                        </label>
                        <input type="file" id="reading-image" class="image-upload-input" accept="image/*" multiple>
                        <div id="reading-image-preview" class="image-preview"></div>
                    </div>

                    <button class="btn-primary" onclick="saveReadingData()">保存阅读记录</button>
                    
                    <!-- 导出按钮 -->
                    <div class="module-export-section">
                        <h4>📤 导出阅读记录</h4>
                        <div class="time-range-selector">
                            <label>时间范围：</label>
                            <select id="readingTimeRange" class="form-control">
                                <option value="1">最近1天</option>
                                <option value="7">最近1周</option>
                                <option value="30">最近1个月</option>
                                <option value="90">最近3个月</option>
                                <option value="180">最近6个月</option>
                                <option value="365">最近1年</option>
                                <option value="all" selected>所有时间</option>
                            </select>
                        </div>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportModuleData('reading', 'smart')">📝 智能整理</button>
                            <button class="export-btn" onclick="exportModuleData('reading', 'json')">📄 JSON格式</button>
                            <button class="export-btn" onclick="exportModuleData('reading', 'csv')">📊 CSV格式</button>
                            <button class="export-btn" onclick="exportModuleData('reading', 'txt')">📝 文本格式</button>
                        </div>
                    </div>
                </div>

                <!-- 情绪模块 -->
                <div id="emotion" class="module">
                    <h2>😊 情绪状态</h2>
                    <div class="form-group">
                        <label>整体情绪</label>
                        <div class="emotion-grid">
                            <button class="emotion-btn" onclick="selectEmotion('开心')">😊 开心</button>
                            <button class="emotion-btn" onclick="selectEmotion('平静')">😌 平静</button>
                            <button class="emotion-btn" onclick="selectEmotion('兴奋')">🤩 兴奋</button>
                            <button class="emotion-btn" onclick="selectEmotion('焦虑')">😰 焦虑</button>
                            <button class="emotion-btn" onclick="selectEmotion('疲惫')">😴 疲惫</button>
                            <button class="emotion-btn" onclick="selectEmotion('沮丧')">😔 沮丧</button>
                            <button class="emotion-btn" onclick="selectEmotion('愤怒')">😠 愤怒</button>
                            <button class="emotion-btn" onclick="selectEmotion('满足')">😌 满足</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>情绪强度</label>
                        <div class="rating-group">
                            <span>强度评分：</span>
                            <div id="emotionIntensity">
                                <button class="rating-btn" onclick="setRating('emotionIntensity', 1)">1</button>
                                <button class="rating-btn" onclick="setRating('emotionIntensity', 2)">2</button>
                                <button class="rating-btn" onclick="setRating('emotionIntensity', 3)">3</button>
                                <button class="rating-btn" onclick="setRating('emotionIntensity', 4)">4</button>
                                <button class="rating-btn" onclick="setRating('emotionIntensity', 5)">5</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>情绪触发事件</label>
                        <textarea id="emotionTrigger" class="form-control" placeholder="是什么事情影响了你的情绪？"></textarea>
                    </div>
                    <div class="form-group">
                        <label>情绪调节方法</label>
                        <textarea id="emotionRegulation" class="form-control" placeholder="你是如何调节情绪的？"></textarea>
                    </div>

                    <!-- 图片上传区域 -->
                    <div class="image-upload-section">
                        <label for="emotion-image" class="image-upload-label">
                            📷 点击上传情绪图片
                        </label>
                        <input type="file" id="emotion-image" class="image-upload-input" accept="image/*" multiple>
                        <div id="emotion-image-preview" class="image-preview"></div>
                    </div>

                    <button class="btn-primary" onclick="saveEmotionData()">保存情绪记录</button>
                    
                    <!-- 导出按钮 -->
                    <div class="module-export-section">
                        <h4>📤 导出情绪记录</h4>
                        <div class="time-range-selector">
                            <label>时间范围：</label>
                            <select id="emotionTimeRange" class="form-control">
                                <option value="1">最近1天</option>
                                <option value="7">最近1周</option>
                                <option value="30">最近1个月</option>
                                <option value="90">最近3个月</option>
                                <option value="180">最近6个月</option>
                                <option value="365">最近1年</option>
                                <option value="all" selected>所有时间</option>
                            </select>
                        </div>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportModuleData('emotion', 'smart')">📝 智能整理</button>
                            <button class="export-btn" onclick="exportModuleData('emotion', 'json')">📄 JSON格式</button>
                            <button class="export-btn" onclick="exportModuleData('emotion', 'csv')">📊 CSV格式</button>
                            <button class="export-btn" onclick="exportModuleData('emotion', 'txt')">📝 文本格式</button>
                        </div>
                    </div>
                </div>

                <!-- 图片时间轴模块 -->
                <div id="timeline" class="module">
                    <h2>📸 图片时间轴</h2>
                    
                    <!-- 标签管理面板 -->
                    <div class="tag-management-panel">
                        <h3>🏷️ 标签管理中心</h3>
                        <div class="tag-stats">
                            <div class="tag-stat-item">
                                <span class="tag-stat-number" id="totalTagsCount">0</span>
                                <span class="tag-stat-label">总标签数</span>
                            </div>
                            <div class="tag-stat-item">
                                <span class="tag-stat-number" id="taggedImagesCount">0</span>
                                <span class="tag-stat-label">已标记图片</span>
                            </div>
                            <div class="tag-stat-item">
                                <span class="tag-stat-number" id="mostUsedTagCount">0</span>
                                <span class="tag-stat-label">最热标签使用次数</span>
                            </div>
                        </div>
                        <div class="tag-cloud" id="tagCloud">
                            <!-- 标签云将在这里动态生成 -->
                        </div>
                    </div>
                    
                    <!-- 时间轴控制面板 -->
                    <div class="timeline-controls">
                        <div class="timeline-filters">
                            <div class="filter-group">
                                <label>📅 时间范围：</label>
                                <select id="timelineRange" class="form-control" onchange="filterTimeline()">
                                    <option value="7">最近一周</option>
                                    <option value="30">最近一月</option>
                                    <option value="90">最近三月</option>
                                    <option value="365">最近一年</option>
                                    <option value="all" selected>全部时间</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>🏷️ 模块筛选：</label>
                                <select id="moduleFilter" class="form-control" onchange="filterTimeline()">
                                    <option value="all" selected>全部模块</option>
                                    <option value="plan">📅 计划</option>
                                    <option value="exercise">🏃‍♂️ 运动</option>
                                    <option value="study">📚 学习</option>
                                    <option value="reading">📖 阅读</option>
                                    <option value="emotion">😊 情绪</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>🔍 标签搜索：</label>
                                <input type="text" id="tagSearch" class="form-control" placeholder="输入标签关键词" onkeyup="filterTimeline()">
                            </div>
                        </div>
                        
                        <div class="timeline-stats">
                            <div class="stat-item">
                                <span class="stat-label">总图片数：</span>
                                <span id="totalImages" class="stat-value">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">已筛选：</span>
                                <span id="filteredImages" class="stat-value">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 时间轴内容 -->
                    <div class="timeline-container">
                        <div id="timelineContent" class="timeline-content">
                            <div class="timeline-empty">
                                <div class="empty-icon">📷</div>
                                <h3>还没有图片记录</h3>
                                <p>开始在各个模块中上传图片，记录你的成长历程吧！</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据面板 -->
                <div id="dashboard" class="module">
                    <h2>📊 成长数据面板</h2>
                    
                    <!-- 今日记录概览 -->
                    <div class="today-records-section">
                        <h3>📅 今日记录</h3>
                        <div class="today-records-grid">
                            <div class="record-category">
                                <h4>📋 今日计划</h4>
                                <div id="todayPlans" class="record-list"></div>
                            </div>
                            <div class="record-category">
                                <h4>🏃‍♂️ 运动记录</h4>
                                <div id="todayExercises" class="record-list"></div>
                            </div>
                            <div class="record-category">
                                <h4>📚 学习记录</h4>
                                <div id="todayStudies" class="record-list"></div>
                            </div>
                            <div class="record-category">
                                <h4>📖 阅读记录</h4>
                                <div id="todayReadings" class="record-list"></div>
                            </div>
                            <div class="record-category">
                                <h4>😊 情绪记录</h4>
                                <div id="todayEmotions" class="record-list"></div>
                            </div>
                        </div>
                    </div>

                    <div class="data-summary">
                        <div class="summary-card">
                            <h3>总记录天数</h3>
                            <div class="value" id="totalDays">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>平均运动时长</h3>
                            <div class="value" id="avgExercise">0分钟</div>
                        </div>
                        <div class="summary-card">
                            <h3>平均学习时长</h3>
                            <div class="value" id="avgStudy">0分钟</div>
                        </div>
                        <div class="summary-card">
                            <h3>平均阅读时长</h3>
                            <div class="value" id="avgReading">0分钟</div>
                        </div>
                        <div class="summary-card">
                            <h3>情绪平均分</h3>
                            <div class="value" id="avgEmotion">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>阅读书籍数量</h3>
                            <div class="value" id="totalBooks">0本</div>
                        </div>
                        <!-- 新增图片相关统计 -->
                        <div class="summary-card image-stats">
                            <h3>📷 总图片数量</h3>
                            <div class="value" id="totalImagesCount">0张</div>
                        </div>
                        <div class="summary-card image-stats">
                            <h3>🏷️ 标签总数</h3>
                            <div class="value" id="totalTagsInStats">0个</div>
                        </div>
                        <div class="summary-card image-stats">
                            <h3>📈 本月新增图片</h3>
                            <div class="value" id="monthlyImages">0张</div>
                        </div>
                    </div>

                    <!-- 图片成长统计面板 -->
                    <div class="image-growth-panel">
                        <h3>📸 图片成长统计</h3>
                        <div class="image-stats-grid">
                            <div class="image-stat-card">
                                <h4>📅 按模块分布</h4>
                                <div id="moduleDistribution" class="module-distribution"></div>
                            </div>
                            <div class="image-stat-card">
                                <h4>📊 月度趋势</h4>
                                <div id="monthlyTrend" class="monthly-trend"></div>
                            </div>
                            <div class="image-stat-card">
                                <h4>🏆 热门标签 TOP 10</h4>
                                <div id="topTags" class="top-tags-list"></div>
                            </div>
                            <div class="image-stat-card">
                                <h4>⏰ 上传时间分布</h4>
                                <div id="timeDistribution" class="time-distribution"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                    
                    <div class="export-section">
                        <h3>导出数据</h3>
                        <p>将你的成长数据导出为图片或数据文件</p>
                        <div class="export-buttons-grid">
                            <button class="export-btn" onclick="exportAsImage()">📸 导出为图片</button>
                            <button class="export-btn" onclick="exportAsData()">📄 导出数据</button>
                            <button class="export-btn" onclick="generateQRCode()">📱 生成二维码</button>
                            <button class="export-btn" onclick="clearAllData()">🗑️ 清空数据</button>
                        </div>
                    </div>
                </div>

                <!-- 年度总结模块 -->
                <div id="annual-summary" class="module">
                    <h2>🎊 年度总结</h2>
                    
                    <!-- 年度总结控制面板 -->
                    <div class="annual-controls">
                        <div class="year-selector">
                            <label>📅 选择年份：</label>
                            <select id="summaryYear" class="form-control" onchange="generateAnnualSummary()">
                                <!-- 年份选项将动态生成 -->
                            </select>
                        </div>
                        <button class="btn-primary" onclick="generateAnnualSummary()">🎯 生成年度总结</button>
                        <button class="btn-secondary" onclick="exportAnnualSummary()">📸 导出总结</button>
                    </div>

                    <!-- 年度总结内容 -->
                    <div id="annualSummaryContent" class="annual-summary-content">
                        <div class="summary-placeholder">
                            <p>🎊 选择年份并点击"生成年度总结"来查看你的成长轨迹</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片详情模态框 -->
    <div id="imageModal" class="modal" style="display: none;">
        <div class="modal-content image-modal-content">
            <div class="modal-header">
                <h3>📷 图片详情</h3>
                <span class="close" onclick="closeImageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-detail-container">
                    <div class="image-display">
                        <img id="modalImage" src="" alt="图片预览">
                    </div>
                    <div class="image-info">
                        <div class="form-group">
                            <label for="modalDescription">📝 图片描述：</label>
                            <textarea id="modalDescription" placeholder="为这张图片添加描述，记录当时的心情、想法或故事..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="modalTags">🏷️ 标签：</label>
                            <div class="tag-input-container">
                                <input type="text" id="modalTags" placeholder="输入标签并按回车添加">
                                <div id="tagSuggestions" class="tag-suggestions"></div>
                            </div>
                            <div id="currentTags" class="current-tags"></div>
                            <div class="popular-tags">
                                <span class="popular-tags-label">常用标签：</span>
                                <div id="popularTags" class="popular-tags-list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>⏰ 上传时间：</label>
                            <span id="modalTimestamp" class="timestamp"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeImageModal()">取消</button>
                <button class="btn-primary" onclick="saveImageInfo()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        let growthData = JSON.parse(localStorage.getItem('growthData')) || {
            plans: [],
            exercises: [],
            studies: [],
            readings: [],
            emotions: []
        };

        // 图片存储
        let imageData = JSON.parse(localStorage.getItem('imageData')) || {
            plan: {},
            exercise: {},
            study: {},
            reading: {},
            emotion: {}
        };

        let currentRatings = {};
        let currentEmotion = '';
        let quotes = [];

        // 图片上传处理函数
        function setupImageUpload() {
            const modules = ['plan', 'exercise', 'study', 'reading', 'emotion'];
            
            modules.forEach(module => {
                const input = document.getElementById(`${module}-image`);
                const preview = document.getElementById(`${module}-image-preview`);
                
                if (input && preview) {
                    input.addEventListener('change', function(e) {
                        handleImageUpload(e, module, preview);
                    });
                    
                    // 显示已存储的图片
                    displayStoredImages(module, preview);
                }
            });
        }

        function handleImageUpload(event, module, previewContainer) {
            const files = event.target.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        const imageUrl = e.target.result;
                        
                        // 存储图片数据
                        if (!imageData[module]) {
                            imageData[module] = {};
                        }
                        imageData[module][imageId] = {
                            url: imageUrl,
                            name: file.name,
                            timestamp: new Date().toISOString(),
                            description: '',
                            tags: []
                        };
                        
                        // 保存到localStorage
                        localStorage.setItem('imageData', JSON.stringify(imageData));
                        
                        // 显示图片
                        displayImage(imageId, imageUrl, file.name, module, previewContainer);
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // 清空input
            event.target.value = '';
        }

        function displayImage(imageId, imageUrl, imageName, module, container) {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.innerHTML = `
                <img src="${imageUrl}" alt="${imageName}" title="${imageName}" onclick="console.log('Image clicked:', '${imageId}', '${module}'); openImageModal('${imageId}', '${module}')">
                <button class="image-remove" onclick="removeImage('${imageId}', '${module}', this)">×</button>
                <div class="image-description-preview" onclick="console.log('Description clicked:', '${imageId}', '${module}'); openImageModal('${imageId}', '${module}')">
                    ${imageData[module][imageId]?.description ? imageData[module][imageId].description.substring(0, 20) + '...' : '点击添加描述'}
                </div>
            `;
            container.appendChild(imageItem);
        }

        function displayStoredImages(module, container) {
            container.innerHTML = '';
            if (imageData[module]) {
                Object.entries(imageData[module]).forEach(([imageId, data]) => {
                    displayImage(imageId, data.url, data.name, module, container);
                });
            }
        }

        function removeImage(imageId, module, button) {
            // 从数据中删除
            if (imageData[module] && imageData[module][imageId]) {
                delete imageData[module][imageId];
                localStorage.setItem('imageData', JSON.stringify(imageData));
            }
            
            // 从DOM中删除
            button.parentElement.remove();
        }

        // 获取模块的图片数据
        function getModuleImages(module) {
            return imageData[module] || {};
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为明天
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('planDate').value = tomorrow.toISOString().split('T')[0];
            
            // 初始化图片上传功能
            setupImageUpload();
            
            // 初始化标签系统
            initTagSystem();
            
            // 初始化用户姓名和每日语录
            initializeUserName();
            updateDailyQuote();
            
            updateDashboard();
        });

        // 显示模块
        function showModule(moduleId) {
            // 隐藏所有模块
            document.querySelectorAll('.module').forEach(module => {
                module.classList.remove('active');
            });
            
            // 移除所有导航项的active状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 显示选中的模块
            document.getElementById(moduleId).classList.add('active');
            
            // 设置对应导航项为active
            event.target.classList.add('active');
            
            // 如果是数据面板，更新图表
            if (moduleId === 'dashboard') {
                updateDashboard();
            }
        }

        // 设置评分
        function setRating(type, rating) {
            currentRatings[type] = rating;
            
            // 更新UI
            const ratingContainer = document.getElementById(type);
            if (ratingContainer) {
                const buttons = ratingContainer.querySelectorAll('.rating-btn');
                buttons.forEach((btn, index) => {
                    if (index < rating) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
        }

        // 选择情绪
        function selectEmotion(emotion) {
            currentEmotion = emotion;
            
            // 更新UI
            document.querySelectorAll('.emotion-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        // 添加摘录
        function addQuote() {
            const quoteText = document.getElementById('readingQuotes').value.trim();
            if (quoteText) {
                quotes.push({
                    text: quoteText,
                    date: new Date().toLocaleDateString()
                });
                
                updateQuotesDisplay();
                document.getElementById('readingQuotes').value = '';
            }
        }

        // 更新摘录显示
        function updateQuotesDisplay() {
            const container = document.getElementById('quotesContainer');
            container.innerHTML = quotes.map(quote => `
                <div class="quote-item">
                    <div class="quote-text">"${quote.text}"</div>
                    <div class="quote-reflection">摘录于 ${quote.date}</div>
                </div>
            `).join('');
        }

        // 保存计划数据
        function savePlanData() {
            const selectedDate = document.getElementById('planDate').value;
            
            // 如果选择的是明日计划，设置保存时间为第2天凌晨
            let saveDate;
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            if (selectedDate === tomorrow.toISOString().split('T')[0]) {
                // 明日计划，设置为第2天凌晨（即后天凌晨）
                const dayAfterTomorrow = new Date(tomorrow);
                dayAfterTomorrow.setDate(tomorrow.getDate() + 1);
                dayAfterTomorrow.setHours(0, 0, 0, 0);
                saveDate = dayAfterTomorrow.toLocaleDateString();
            } else {
                // 其他日期的计划，使用选择的日期
                saveDate = new Date(selectedDate).toLocaleDateString();
            }
            
            const planData = {
                date: saveDate,
                originalDate: selectedDate, // 保留原始选择的日期
                mainGoals: document.getElementById('mainGoals').value,
                detailPlan: document.getElementById('detailPlan').value,
                expectedCompletion: currentRatings.plan || 0,
                images: getModuleImages('plan'),
                timestamp: new Date().toISOString()
            };
            
            growthData.plans.push(planData);
            saveToLocalStorage();
            updateDashboard();
            alert('计划已保存！');
            clearPlanForm();
        }

        // 学习主题管理
        let studyTopics = [];

        // 添加学习主题
        function addStudyTopic() {
            const input = document.getElementById('newStudyTopic');
            const topicName = input.value.trim();
            
            if (!topicName) {
                alert('请输入学习主题');
                return;
            }
            
            if (studyTopics.some(topic => topic.name === topicName)) {
                alert('该主题已存在');
                return;
            }
            
            const topic = {
                name: topicName,
                duration: 0
            };
            
            studyTopics.push(topic);
            input.value = '';
            renderStudyTopics();
            updateTimeAllocation();
        }

        // 渲染学习主题标签
        function renderStudyTopics() {
            const container = document.getElementById('studyTopicTags');
            container.innerHTML = '';
            
            studyTopics.forEach((topic, index) => {
                const tag = document.createElement('div');
                tag.className = 'topic-tag';
                tag.innerHTML = `
                    <span class="topic-name">${topic.name}</span>
                    <div class="topic-time-input">
                        <input type="number" 
                               value="${topic.duration || ''}" 
                               placeholder="分钟" 
                               min="0" 
                               onchange="updateTopicTime(${index}, this.value)"
                               onclick="event.stopPropagation()">
                        <span class="time-unit">分钟</span>
                    </div>
                    <button class="remove-btn" onclick="removeStudyTopic(${index})">×</button>
                `;
                container.appendChild(tag);
            });
            
            updateTotalTime();
        }

        // 更新单个主题的时间
        function updateTopicTime(index, duration) {
            const numDuration = parseInt(duration) || 0;
            studyTopics[index].duration = numDuration;
            updateTotalTime();
        }

        // 删除学习主题
        function removeStudyTopic(index) {
            studyTopics.splice(index, 1);
            renderStudyTopics();
        }

        // 更新总时间显示
        function updateTotalTime() {
            const totalMinutes = studyTopics.reduce((sum, topic) => sum + (topic.duration || 0), 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            const minutesDisplay = document.querySelector('.time-minutes');
            const hoursDisplay = document.querySelector('.time-hours');
            
            if (minutesDisplay) {
                minutesDisplay.textContent = `${totalMinutes}分钟`;
            }
            
            if (hoursDisplay) {
                if (hours > 0) {
                    hoursDisplay.textContent = `(${hours}小时${minutes > 0 ? minutes + '分钟' : ''})`;
                } else {
                    hoursDisplay.textContent = minutes > 0 ? `(${minutes}分钟)` : '(0小时)';
                }
            }
        }



        // 处理运动类型选择
        function handleExerciseTypeChange() {
            const select = document.getElementById('exerciseTypeSelect');
            const input = document.getElementById('exerciseType');
            
            if (select.value === '其他') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
                input.value = select.value;
            }
        }

        // 保存运动数据
        function saveExerciseData() {
            const select = document.getElementById('exerciseTypeSelect');
            const input = document.getElementById('exerciseType');
            const exerciseType = select.value === '其他' ? input.value : select.value;
            
            // 设置保存时间为当天晚上12点
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setHours(23, 59, 59, 999); // 当天晚上11:59:59
            
            const exerciseData = {
                type: exerciseType,
                duration: parseInt(document.getElementById('exerciseDuration').value) || 0,
                intensity: currentRatings.exerciseIntensity || 0,
                feeling: document.getElementById('exerciseFeeling').value,
                images: getModuleImages('exercise'),
                date: now.toLocaleDateString(),
                expiryTime: endOfDay.toISOString(), // 记录过期时间
                timestamp: new Date().toISOString()
            };
            
            growthData.exercises.push(exerciseData);
            saveToLocalStorage();
            updateDashboard();
            alert('运动记录已保存！');
            clearExerciseForm();
        }

        // 保存学习数据
        function saveStudyData() {
            if (studyTopics.length === 0) {
                alert('请先添加学习主题');
                return;
            }
            
            // 验证每个主题都有时间输入
            const hasEmptyTime = studyTopics.some(topic => !topic.duration || topic.duration <= 0);
            if (hasEmptyTime) {
                alert('请为每个学习主题输入时间');
                return;
            }
            
            const totalDuration = studyTopics.reduce((sum, topic) => sum + (topic.duration || 0), 0);
            
            // 设置保存时间为当天晚上12点
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setHours(23, 59, 59, 999); // 当天晚上11:59:59
            
            const studyData = {
                topics: studyTopics.map(topic => ({
                    name: topic.name,
                    duration: topic.duration
                })),
                totalDuration: totalDuration,
                content: document.getElementById('studyContent').value,
                mastery: currentRatings.studyMastery || 0,
                gains: document.getElementById('studyGains').value,
                images: getModuleImages('study'),
                date: now.toLocaleDateString(),
                expiryTime: endOfDay.toISOString(), // 记录过期时间
                timestamp: new Date().toISOString()
            };
            
            growthData.studies.push(studyData);
            saveToLocalStorage();
            updateDashboard();
            alert('学习记录已保存！');
            clearStudyForm();
        }

        // 保存阅读数据
        function saveReadingData() {
            // 设置保存时间为当天晚上12点
            const now = new Date();
            const endOfDay = new Date(now);
            endOfDay.setHours(23, 59, 59, 999); // 当天晚上11:59:59
            
            const readingData = {
                title: document.getElementById('readingTitle').value,
                progress: document.getElementById('readingProgress').value,
                quotes: [...quotes],
                reflection: document.getElementById('readingReflection').value,
                rating: currentRatings.readingRating || 0,
                images: getModuleImages('reading'),
                date: now.toLocaleDateString(),
                expiryTime: endOfDay.toISOString(), // 记录过期时间
                timestamp: new Date().toISOString()
            };
            
            growthData.readings.push(readingData);
            saveToLocalStorage();
            updateDashboard();
            alert('阅读记录已保存！');
            clearReadingForm();
        }

        // 保存情绪数据
        function saveEmotionData() {
            const emotionData = {
                emotion: currentEmotion,
                intensity: currentRatings.emotionIntensity || 0,
                trigger: document.getElementById('emotionTrigger').value,
                regulation: document.getElementById('emotionRegulation').value,
                images: getModuleImages('emotion'),
                date: new Date().toLocaleDateString(),
                timestamp: new Date().toISOString()
            };
            
            growthData.emotions.push(emotionData);
            saveToLocalStorage();
            updateDashboard();
            alert('情绪记录已保存！');
            clearEmotionForm();
        }

        // 清空表单
        function clearPlanForm() {
            document.getElementById('mainGoals').value = '';
            document.getElementById('detailPlan').value = '';
            currentRatings.plan = 0;
            document.querySelectorAll('#planRating .rating-btn').forEach(btn => btn.classList.remove('active'));
        }

        function clearExerciseForm() {
            document.getElementById('exerciseType').value = '';
            document.getElementById('exerciseDuration').value = '';
            document.getElementById('exerciseFeeling').value = '';
            currentRatings.exerciseIntensity = 0;
            document.querySelectorAll('#exerciseIntensity .rating-btn').forEach(btn => btn.classList.remove('active'));
        }

        function clearStudyForm() {
            studyTopics = [];
            renderStudyTopics();
            document.getElementById('newStudyTopic').value = '';
            document.getElementById('studyContent').value = '';
            document.getElementById('studyGains').value = '';
            currentRatings.studyMastery = 0;
            document.querySelectorAll('#studyMastery .rating-btn').forEach(btn => btn.classList.remove('active'));
        }

        function clearReadingForm() {
            document.getElementById('readingTitle').value = '';
            document.getElementById('readingProgress').value = '';
            document.getElementById('readingQuotes').value = '';
            document.getElementById('readingReflection').value = '';
            quotes = [];
            updateQuotesDisplay();
            currentRatings.readingRating = 0;
            document.querySelectorAll('#readingRating .rating-btn').forEach(btn => btn.classList.remove('active'));
        }

        function clearEmotionForm() {
            document.getElementById('emotionTrigger').value = '';
            document.getElementById('emotionRegulation').value = '';
            currentEmotion = '';
            currentRatings.emotionIntensity = 0;
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#emotionIntensity .rating-btn').forEach(btn => btn.classList.remove('active'));
        }

        // 保存到本地存储
        function saveToLocalStorage() {
            localStorage.setItem('growthData', JSON.stringify(growthData));
        }

        // 更新数据面板
        function updateDashboard() {
            // 计算统计数据
            const totalDays = new Set([
                ...growthData.exercises.map(e => e.date),
                ...growthData.studies.map(s => s.date),
                ...growthData.readings.map(r => r.date),
                ...growthData.emotions.map(em => em.date)
            ]).size;

            const avgExercise = growthData.exercises.length > 0 
                ? Math.round(growthData.exercises.reduce((sum, e) => sum + e.duration, 0) / growthData.exercises.length)
                : 0;

            const avgStudy = growthData.studies.length > 0
                ? Math.round(growthData.studies.reduce((sum, s) => {
                    // 支持新的多主题结构和旧的单主题结构
                    if (s.topics && Array.isArray(s.topics)) {
                        return sum + s.totalDuration;
                    } else {
                        return sum + (s.duration || 0);
                    }
                }, 0) / growthData.studies.length)
                : 0;

            // 计算阅读数据
            const avgReading = growthData.readings.length > 0
                ? Math.round(growthData.readings.reduce((sum, r) => {
                    // 尝试从progress字段提取时长（如果包含"分钟"）
                    const match = r.progress.match(/(\d+)分钟/);
                    return sum + (match ? parseInt(match[1]) : 0);
                }, 0) / growthData.readings.length)
                : 0;

            const totalBooks = new Set(growthData.readings.map(r => r.title)).size;

            const avgEmotion = growthData.emotions.length > 0
                ? (growthData.emotions.reduce((sum, e) => sum + e.intensity, 0) / growthData.emotions.length).toFixed(1)
                : 0;

            // 更新显示
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('avgExercise').textContent = avgExercise + '分钟';
            document.getElementById('avgStudy').textContent = avgStudy + '分钟';
            document.getElementById('avgReading').textContent = avgReading + '分钟';
            document.getElementById('totalBooks').textContent = totalBooks + '本';
            document.getElementById('avgEmotion').textContent = avgEmotion;

            // 更新今日记录显示
            updateTodayRecords();

            // 更新图表
            updateChart();
        }

        // 更新今日记录显示
        function updateTodayRecords() {
            const today = new Date().toLocaleDateString();
            
            // 显示今日计划
            const todayPlans = growthData.plans.filter(p => p.date === today);
            displayTodayRecords('todayPlans', todayPlans, (plan) => 
                `<div class="record-item">
                    <strong>目标：</strong>${plan.mainGoals}<br>
                    <strong>详细计划：</strong>${plan.detailPlan}
                    <div class="record-time">${new Date(plan.timestamp).toLocaleTimeString()}</div>
                </div>`
            );

            // 显示今日运动
            const todayExercises = growthData.exercises.filter(e => e.date === today);
            displayTodayRecords('todayExercises', todayExercises, (exercise) => 
                `<div class="record-item">
                    <strong>${exercise.type}</strong> - ${exercise.duration}分钟<br>
                    强度：${exercise.intensity}/5 ${exercise.feeling ? '| ' + exercise.feeling : ''}
                    <div class="record-time">${new Date(exercise.timestamp).toLocaleTimeString()}</div>
                </div>`
            );

            // 显示今日学习
            const todayStudies = growthData.studies.filter(s => s.date === today);
            displayTodayRecords('todayStudies', todayStudies, (study) => {
                const duration = study.topics ? study.totalDuration : (study.duration || 0);
                const topics = study.topics ? study.topics.map(t => t.name).join(', ') : (study.subject || '');
                return `<div class="record-item">
                    <strong>主题：</strong>${topics}<br>
                    <strong>时长：</strong>${duration}分钟 | 掌握度：${study.mastery}/5
                    <div class="record-time">${new Date(study.timestamp).toLocaleTimeString()}</div>
                </div>`;
            });

            // 显示今日阅读
            const todayReadings = growthData.readings.filter(r => r.date === today);
            displayTodayRecords('todayReadings', todayReadings, (reading) => 
                `<div class="record-item">
                    <strong>书籍：</strong>${reading.title}<br>
                    <strong>进度：</strong>${reading.progress} | 推荐度：${reading.rating}/5
                    <div class="record-time">${new Date(reading.timestamp).toLocaleTimeString()}</div>
                </div>`
            );

            // 显示今日情绪
            const todayEmotions = growthData.emotions.filter(e => e.date === today);
            displayTodayRecords('todayEmotions', todayEmotions, (emotion) => 
                `<div class="record-item">
                    <strong>情绪：</strong>${emotion.emotion} (强度：${emotion.intensity}/5)<br>
                    ${emotion.trigger ? '<strong>触发事件：</strong>' + emotion.trigger : ''}
                    <div class="record-time">${new Date(emotion.timestamp).toLocaleTimeString()}</div>
                </div>`
            );
        }

        // 通用的记录显示函数
        function displayTodayRecords(containerId, records, formatFunction) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (records.length === 0) {
                container.innerHTML = '<div class="no-records">今日暂无记录</div>';
            } else {
                container.innerHTML = records.map(formatFunction).join('');
            }
        }

        // 更新图表
        function updateChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            // 获取最近7天的数据
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString());
            }

            const exerciseData = last7Days.map(date => {
                const dayExercise = growthData.exercises.filter(e => e.date === date);
                return dayExercise.reduce((sum, e) => sum + e.duration, 0);
            });

            const studyData = last7Days.map(date => {
                const dayStudy = growthData.studies.filter(s => s.date === date);
                return dayStudy.reduce((sum, s) => {
                    // 支持新的多主题结构和旧的单主题结构
                    if (s.topics && Array.isArray(s.topics)) {
                        return sum + s.totalDuration;
                    } else {
                        return sum + (s.duration || 0);
                    }
                }, 0);
            });

            const readingData = last7Days.map(date => {
                const dayReading = growthData.readings.filter(r => r.date === date);
                return dayReading.reduce((sum, r) => {
                    // 提取阅读时长（分钟）
                    if (r.progress) {
                        const match = r.progress.match(/(\d+)分钟/);
                        return sum + (match ? parseInt(match[1]) : 0);
                    }
                    return sum;
                }, 0);
            });

            const emotionData = last7Days.map(date => {
                const dayEmotion = growthData.emotions.filter(e => e.date === date);
                return dayEmotion.length > 0 ? dayEmotion[0].intensity : 0;
            });

            // 销毁现有图表
            if (window.growthChart && typeof window.growthChart.destroy === 'function') {
                window.growthChart.destroy();
            }

            // 创建新图表
            window.growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => {
                        const d = new Date(date);
                        return (d.getMonth() + 1) + '/' + d.getDate();
                    }),
                    datasets: [{
                        label: '运动时长(分钟)',
                        data: exerciseData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: '学习时长(分钟)',
                        data: studyData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4
                    }, {
                        label: '阅读时长(分钟)',
                        data: readingData,
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4
                    }, {
                        label: '情绪评分',
                        data: emotionData.map(score => score * 20), // 放大显示
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '时长(分钟)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '情绪评分'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '最近7天成长趋势'
                        }
                    }
                }
            });
        }

        // 导出为图片
        async function exportAsImage() {
            // 创建包含图片的完整导出内容
            const exportContent = document.createElement('div');
            
            try {
                console.log('开始导出图片...');
                alert('正在生成图片，请稍候...');
                
                const dashboard = document.getElementById('dashboard');
                console.log('Dashboard元素:', dashboard);
                exportContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    width: 800px; /* 固定宽度，避免过宽 */
                    margin: 0 auto;
                    box-sizing: border-box;
                    min-height: auto; /* 让高度自适应内容 */
                `;
            
            // 添加标题
            const title = document.createElement('h1');
            title.textContent = '个人成长仪表板';
            title.style.cssText = `
                text-align: center;
                color: #333;
                margin-bottom: 20px;
                font-size: 24px; /* 适中的标题字体大小 */
                font-weight: bold;
            `;
            exportContent.appendChild(title);
            
            // 添加日期
            const dateDiv = document.createElement('div');
            dateDiv.textContent = `生成时间: ${new Date().toLocaleString()}`;
            dateDiv.style.cssText = `
                text-align: center;
                color: #666;
                margin-bottom: 25px;
                font-size: 14px; /* 适中的日期字体大小 */
                font-weight: 500;
            `;
            exportContent.appendChild(dateDiv);
            
            // 克隆仪表板内容
            const dashboardClone = dashboard.cloneNode(true);
            exportContent.appendChild(dashboardClone);
            
            // 添加各模块的图片
            const modules = ['plan', 'exercise', 'study', 'reading', 'emotion'];
            const moduleNames = {
                plan: '计划模块',
                exercise: '运动模块', 
                study: '学习模块',
                reading: '阅读模块',
                emotion: '情绪模块'
            };
            
            for (const module of modules) {
                const moduleImages = getModuleImages(module);
                console.log(`${module} 模块图片数据:`, moduleImages);
                console.log(`${module} 模块图片数量:`, Object.keys(moduleImages).length);
                
                if (Object.keys(moduleImages).length > 0) {
                    const moduleSection = document.createElement('div');
                    moduleSection.style.cssText = `
                        margin-top: 20px;
                        padding: 15px;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                    `;
                    
                    const moduleTitle = document.createElement('h3');
                    moduleTitle.textContent = moduleNames[module] + ' - 相关图片';
                    moduleTitle.style.cssText = `
                        color: #333;
                        margin-bottom: 12px;
                        font-size: 16px; /* 适中的模块标题字体大小 */
                        font-weight: bold;
                    `;
                    moduleSection.appendChild(moduleTitle);
                    
                    const imageGrid = document.createElement('div');
                    imageGrid.style.cssText = `
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* 适中的图片宽度 */
                        gap: 15px; /* 适中的间距 */
                        margin-top: 15px;
                    `;
                    
                    Object.values(moduleImages).forEach(imageData => {
                        const imgContainer = document.createElement('div');
                        imgContainer.style.cssText = `
                            text-align: center;
                        `;
                        
                        const img = document.createElement('img');
                        img.src = imageData.url;
                        img.style.cssText = `
                            max-width: 100%;
                            height: 150px; /* 适中的图片高度 */
                            object-fit: cover;
                            border-radius: 6px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* 适中的阴影效果 */
                        `;
                        // 确保图片加载
                        img.crossOrigin = 'anonymous';
                        
                        const imgName = document.createElement('div');
                        imgName.textContent = imageData.name;
                        imgName.style.cssText = `
                            font-size: 12px; /* 适中的字体大小 */
                            color: #333;
                            margin-top: 6px;
                            font-weight: 500;
                        `;
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(imgName);
                        imageGrid.appendChild(imgContainer);
                    });
                    
                    moduleSection.appendChild(imageGrid);
                    exportContent.appendChild(moduleSection);
                }
            }
            
            // 临时添加到页面进行截图
            document.body.appendChild(exportContent);
            
            // 等待所有图片加载完成
            const images = exportContent.querySelectorAll('img');
            await Promise.all(Array.from(images).map(img => {
                return new Promise((resolve) => {
                    if (img.complete) {
                        resolve();
                    } else {
                        img.onload = resolve;
                        img.onerror = resolve;
                    }
                });
            }));

            console.log('开始使用html2canvas生成图片...');
            console.log('导出内容尺寸:', exportContent.scrollWidth, 'x', exportContent.scrollHeight);
            
            const canvas = await html2canvas(exportContent, {
                backgroundColor: '#ffffff',
                scale: 2, // 降低scale值，避免图片过大导致质量问题
                useCORS: true,
                allowTaint: false,
                foreignObjectRendering: false,
                logging: true, // 开启日志查看问题
                width: exportContent.scrollWidth,
                height: exportContent.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                windowWidth: exportContent.scrollWidth,
                windowHeight: exportContent.scrollHeight,
                imageTimeout: 15000, // 增加图片加载超时时间
                removeContainer: false
            });
            
            console.log('Canvas生成成功，尺寸:', canvas.width, 'x', canvas.height);
            
            // 下载图片 - 使用更高质量的JPEG格式
            const link = document.createElement('a');
            link.download = `成长仪表板_${new Date().toLocaleDateString().replace(/\//g, '-')}.png`;
            // 使用最高质量导出
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            console.log('图片导出完成');
            alert('成长仪表板已导出为图片！');
            } catch (error) {
                console.error('导出失败，详细错误信息:', error);
                console.error('错误堆栈:', error.stack);
                alert(`导出失败: ${error.message}，请查看控制台获取详细信息！`);
            } finally {
                // 移除临时元素
                if (exportContent && exportContent.parentNode) {
                    document.body.removeChild(exportContent);
                }
            }
        }

        // 导出数据
        function exportAsData() {
            const exportObj = {
                growthData: growthData,
                imageData: imageData,
                quotes: quotes,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `成长数据_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('数据已导出为JSON文件！');
        }

        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                growthData = {
                    plans: [],
                    exercises: [],
                    studies: [],
                    readings: [],
                    emotions: []
                };
                localStorage.removeItem('growthData');
                updateDashboard();
                alert('所有数据已清空！');
            }
        }

        // 生成二维码功能
        function generateQRCode() {
            const currentUrl = window.location.href;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(currentUrl)}`;
            
            // 创建模态框显示二维码
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                max-width: 400px;
                width: 90%;
            `;
            
            content.innerHTML = `
                <h3 style="margin-top: 0; color: #333;">📱 扫码分享</h3>
                <p style="color: #666; margin-bottom: 20px;">扫描二维码在手机上使用</p>
                <img src="${qrApiUrl}" style="width: 250px; height: 250px; border: 2px solid #ddd; border-radius: 10px;" alt="二维码">
                <div style="margin-top: 20px;">
                    <button onclick="downloadQR('${qrApiUrl}')" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        margin: 5px;
                        font-size: 14px;
                    ">💾 下载二维码</button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        background: #f0f0f0;
                        color: #333;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        margin: 5px;
                        font-size: 14px;
                    ">关闭</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 下载二维码
        function downloadQR(qrUrl) {
            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = '成长仪表板二维码.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 导出模块数据
        function exportModuleData(moduleType, format) {
            // 如果是智能整理导出
            if (format === 'smart') {
                exportSmartSummary(moduleType);
                return;
            }
            
            // 获取时间范围筛选的数据
            const timeRangeSelect = document.getElementById(moduleType + 'TimeRange');
            const timeRange = timeRangeSelect ? timeRangeSelect.value : 'all';
            let data = [];
            let filename = '';
            
            switch(moduleType) {
                case 'plan':
                    data = growthData.plans;
                    filename = '计划数据';
                    break;
                case 'exercise':
                    data = growthData.exercises;
                    filename = '运动数据';
                    break;
                case 'study':
                    data = growthData.studies;
                    filename = '学习数据';
                    break;
                case 'reading':
                    data = growthData.readings;
                    filename = '阅读数据';
                    break;
                case 'emotion':
                    data = growthData.emotions;
                    filename = '情绪数据';
                    break;
            }
            
            // 应用时间范围筛选
            if (timeRange !== 'all') {
                const days = parseInt(timeRange);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                data = data.filter(item => {
                    const itemDate = new Date(item.timestamp || item.date);
                    return itemDate >= cutoffDate;
                });
            }
            
            if (data.length === 0) {
                alert('所选时间范围内暂无数据可导出！');
                return;
            }
            
            const timeRangeText = getTimeRangeText(timeRange);
            const dateStr = new Date().toLocaleDateString().replace(/\//g, '-');
            
            if (format === 'json') {
                const dataStr = JSON.stringify(data, null, 2);
                downloadFile(dataStr, `${filename}_${timeRangeText}_${dateStr}.json`, 'application/json');
            } else if (format === 'csv') {
                const csvStr = convertToCSV(data, moduleType);
                downloadFile(csvStr, `${filename}_${timeRangeText}_${dateStr}.csv`, 'text/csv');
            } else if (format === 'txt') {
                const txtStr = convertToTXT(data, moduleType);
                downloadFile(txtStr, `${filename}_${timeRangeText}_${dateStr}.txt`, 'text/plain');
            }
        }

        // 获取时间范围文本
        function getTimeRangeText(timeRange) {
            const rangeMap = {
                '1': '最近1天',
                '7': '最近1周',
                '30': '最近1个月',
                '90': '最近3个月',
                '180': '最近6个月',
                '365': '最近1年',
                'all': '所有时间'
            };
            return rangeMap[timeRange] || '所有时间';
        }

        // 智能整理导出功能
        function exportSmartSummary(moduleType) {
            const timeRangeSelect = document.getElementById(moduleType + 'TimeRange');
            const timeRange = timeRangeSelect ? timeRangeSelect.value : 'all';
            let data = [];
            
            switch(moduleType) {
                case 'plan':
                    data = growthData.plans;
                    break;
                case 'exercise':
                    data = growthData.exercises;
                    break;
                case 'study':
                    data = growthData.studies;
                    break;
                case 'reading':
                    data = growthData.readings;
                    break;
                case 'emotion':
                    data = growthData.emotions;
                    break;
            }
            
            // 应用时间范围筛选
            if (timeRange !== 'all') {
                const days = parseInt(timeRange);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                data = data.filter(item => {
                    const itemDate = new Date(item.timestamp || item.date);
                    return itemDate >= cutoffDate;
                });
            }
            
            if (data.length === 0) {
                alert('所选时间范围内没有数据！');
                return;
            }
            
            let summary = '';
            const timeRangeText = getTimeRangeText(timeRange);
            
            switch (moduleType) {
                case 'plan':
                    summary = generatePlanSummary(data, timeRangeText);
                    break;
                case 'exercise':
                    summary = generateExerciseSummary(data, timeRangeText);
                    break;
                case 'study':
                    summary = generateStudySummary(data, timeRangeText);
                    break;
                case 'reading':
                    summary = generateReadingSummary(data, timeRangeText);
                    break;
                case 'emotion':
                    summary = generateEmotionSummary(data, timeRangeText);
                    break;
            }
            
            const fileName = `${getModuleName(moduleType)}_智能整理_${timeRangeText}_${new Date().toLocaleDateString().replace(/\//g, '-')}.txt`;
            downloadFile(summary, fileName, 'text/plain');
        }

        // 生成计划总结
        function generatePlanSummary(data, timeRange) {
            let summary = `📋 明日计划智能整理报告 (${timeRange})\n`;
            summary += `生成时间：${new Date().toLocaleString()}\n`;
            summary += `数据条数：${data.length}条\n\n`;
            
            summary += `📊 计划概览：\n`;
            summary += `在${timeRange}内，您共制定了${data.length}次明日计划。\n\n`;
            
            if (data.length > 0) {
                let totalExpectedCompletion = 0;
                data.forEach(item => {
                    totalExpectedCompletion += item.expectedCompletion || 0;
                });
                const avgCompletion = (totalExpectedCompletion / data.length).toFixed(1);
                
                summary += `📈 完成度统计：\n`;
                summary += `平均预期完成度：${avgCompletion}/5\n\n`;
                
                summary += `📝 详细计划内容：\n`;
                data.forEach((item, index) => {
                    summary += `${index + 1}. 【${item.date}】\n`;
                    summary += `   主要目标：${item.mainGoals || '无'}\n`;
                    summary += `   详细计划：${item.detailPlan || '无'}\n`;
                    summary += `   预期完成度：${item.expectedCompletion || 0}/5\n`;
                    summary += `   创建时间：${new Date(item.timestamp).toLocaleString()}\n\n`;
                });
            }
            
            return summary;
        }

        // 生成运动总结
        function generateExerciseSummary(data, timeRange) {
            let summary = `🏃‍♂️ 运动记录智能整理报告 (${timeRange})\n`;
            summary += `生成时间：${new Date().toLocaleString()}\n`;
            summary += `数据条数：${data.length}条\n\n`;
            
            if (data.length > 0) {
                const types = {};
                let totalDuration = 0;
                let totalIntensity = 0;
                
                data.forEach(item => {
                    const type = item.type || '其他运动';
                    types[type] = (types[type] || 0) + 1;
                    totalDuration += parseInt(item.duration) || 0;
                    totalIntensity += parseInt(item.intensity) || 0;
                });
                
                summary += `📊 运动统计：\n`;
                summary += `总运动次数：${data.length}次\n`;
                summary += `总运动时长：${totalDuration}分钟\n`;
                summary += `平均每次运动：${Math.round(totalDuration / data.length)}分钟\n`;
                summary += `平均运动强度：${(totalIntensity / data.length).toFixed(1)}/5\n\n`;
                
                summary += `🏃 运动类型分布：\n`;
                Object.entries(types).forEach(([type, count]) => {
                    summary += `${type}：${count}次\n`;
                });
                summary += '\n';
                
                summary += `📝 详细运动记录：\n`;
                data.forEach((item, index) => {
                    summary += `${index + 1}. 【${item.date}】${item.type || '运动'}\n`;
                    summary += `   时长：${item.duration || 0}分钟\n`;
                    summary += `   强度：${item.intensity || 0}/5\n`;
                    summary += `   感受：${item.feeling || '无'}\n`;
                    summary += `   创建时间：${new Date(item.timestamp).toLocaleString()}\n\n`;
                });
            }
            
            return summary;
        }

        // 生成学习总结
        function generateStudySummary(data, timeRange) {
            let summary = `📚 学习记录智能整理报告 (${timeRange})\n`;
            summary += `生成时间：${new Date().toLocaleString()}\n`;
            summary += `数据条数：${data.length}条\n\n`;
            
            if (data.length > 0) {
                let totalDuration = 0;
                let totalMastery = 0;
                const topics = new Set();
                
                data.forEach(item => {
                    totalDuration += parseInt(item.totalDuration || item.duration) || 0;
                    totalMastery += parseInt(item.mastery) || 0;
                    if (item.topics && Array.isArray(item.topics)) {
                        item.topics.forEach(topic => topics.add(topic.name));
                    } else if (item.subject) {
                        topics.add(item.subject);
                    }
                });
                
                summary += `📊 学习统计：\n`;
                summary += `总学习次数：${data.length}次\n`;
                summary += `总学习时长：${totalDuration}分钟\n`;
                summary += `平均每次学习：${Math.round(totalDuration / data.length)}分钟\n`;
                summary += `平均掌握度：${(totalMastery / data.length).toFixed(1)}/5\n`;
                summary += `涉及主题：${topics.size}个\n\n`;
                
                summary += `📖 学习主题：\n`;
                Array.from(topics).forEach((topic, index) => {
                    summary += `${index + 1}. ${topic}\n`;
                });
                summary += '\n';
                
                summary += `📝 详细学习记录：\n`;
                data.forEach((item, index) => {
                    summary += `${index + 1}. 【${item.date}】\n`;
                    summary += `   主题：${item.topics ? item.topics.map(t => t.name).join(', ') : (item.subject || '无')}\n`;
                    summary += `   时长：${item.totalDuration || item.duration || 0}分钟\n`;
                    summary += `   内容：${item.content || '无'}\n`;
                    summary += `   掌握度：${item.mastery || 0}/5\n`;
                    summary += `   收获：${item.gains || '无'}\n`;
                    summary += `   创建时间：${new Date(item.timestamp).toLocaleString()}\n\n`;
                });
            }
            
            return summary;
        }

        // 生成阅读总结
        function generateReadingSummary(data, timeRange) {
            let summary = `📖 阅读记录智能整理报告 (${timeRange})\n`;
            summary += `生成时间：${new Date().toLocaleString()}\n`;
            summary += `数据条数：${data.length}条\n\n`;
            
            if (data.length > 0) {
                const books = new Set();
                let totalRating = 0;
                let ratingCount = 0;
                
                data.forEach(item => {
                    if (item.title) books.add(item.title);
                    if (item.rating) {
                        totalRating += parseInt(item.rating);
                        ratingCount++;
                    }
                });
                
                summary += `📊 阅读统计：\n`;
                summary += `阅读记录：${data.length}条\n`;
                summary += `涉及书籍：${books.size}本\n`;
                if (ratingCount > 0) {
                    summary += `平均推荐度：${(totalRating / ratingCount).toFixed(1)}/5\n`;
                }
                summary += '\n';
                
                summary += `📚 书籍列表：\n`;
                Array.from(books).forEach((book, index) => {
                    summary += `${index + 1}. ${book}\n`;
                });
                summary += '\n';
                
                summary += `📝 详细阅读记录：\n`;
                data.forEach((item, index) => {
                    summary += `${index + 1}. 【${item.date}】\n`;
                    summary += `   书名：${item.title || '无'}\n`;
                    summary += `   进度：${item.progress || '无'}\n`;
                    summary += `   感悟：${item.reflection || '无'}\n`;
                    summary += `   推荐度：${item.rating || 0}/5\n`;
                    summary += `   创建时间：${new Date(item.timestamp).toLocaleString()}\n\n`;
                });
            }
            
            return summary;
        }

        // 生成情绪总结
        function generateEmotionSummary(data, timeRange) {
            let summary = `😊 情绪记录智能整理报告 (${timeRange})\n`;
            summary += `生成时间：${new Date().toLocaleString()}\n`;
            summary += `数据条数：${data.length}条\n\n`;
            
            if (data.length > 0) {
                const emotions = {};
                const triggers = [];
                const regulations = [];
                let totalIntensity = 0;
                
                data.forEach(item => {
                    const emotion = item.emotion || '未记录';
                    emotions[emotion] = (emotions[emotion] || 0) + 1;
                    if (item.trigger) triggers.push(item.trigger);
                    if (item.regulation) regulations.push(item.regulation);
                    totalIntensity += parseInt(item.intensity) || 0;
                });
                
                summary += `📊 情绪统计：\n`;
                summary += `情绪记录：${data.length}条\n`;
                summary += `平均情绪强度：${(totalIntensity / data.length).toFixed(1)}/5\n`;
                summary += `情绪类型分布：\n`;
                Object.entries(emotions).forEach(([emotion, count]) => {
                    summary += `${emotion}：${count}次\n`;
                });
                summary += '\n';
                
                if (triggers.length > 0) {
                    summary += `🎯 主要情绪触发事件：\n`;
                    triggers.slice(0, 5).forEach((trigger, index) => {
                        summary += `${index + 1}. ${trigger}\n`;
                    });
                    summary += '\n';
                }
                
                if (regulations.length > 0) {
                    summary += `🛠️ 情绪调节方法：\n`;
                    regulations.slice(0, 5).forEach((regulation, index) => {
                        summary += `${index + 1}. ${regulation}\n`;
                    });
                    summary += '\n';
                }
                
                summary += `📝 详细情绪记录：\n`;
                data.forEach((item, index) => {
                    summary += `${index + 1}. 【${item.date}】情绪：${item.emotion || '未记录'}\n`;
                    summary += `   强度：${item.intensity || 0}/5\n`;
                    summary += `   触发事件：${item.trigger || '无'}\n`;
                    summary += `   调节方法：${item.regulation || '无'}\n`;
                    summary += `   创建时间：${new Date(item.timestamp).toLocaleString()}\n\n`;
                });
            }
            
            return summary;
        }

        // 转换为CSV格式
        function convertToCSV(data, moduleType) {
            if (data.length === 0) return '';
            
            let headers = [];
            let rows = [];
            
            switch(moduleType) {
                case 'plan':
                    headers = ['日期', '主要目标', '详细计划', '预期完成度', '创建时间'];
                    rows = data.map(item => [
                        item.date || '',
                        item.mainGoals || '',
                        item.detailPlan || '',
                        item.expectedCompletion || 0,
                        new Date(item.timestamp).toLocaleString()
                    ]);
                    break;
                case 'exercise':
                    headers = ['日期', '运动类型', '时长(分钟)', '强度', '感受', '创建时间'];
                    rows = data.map(item => [
                        item.date || '',
                        item.type || '',
                        item.duration || 0,
                        item.intensity || 0,
                        item.feeling || '',
                        new Date(item.timestamp).toLocaleString()
                    ]);
                    break;
                case 'study':
                    headers = ['日期', '学习主题', '总时长(分钟)', '学习内容', '掌握度', '收获', '创建时间'];
                    rows = data.map(item => [
                        item.date || '',
                        item.topics ? item.topics.map(t => t.name).join('; ') : (item.subject || ''),
                        item.totalDuration || item.duration || 0,
                        item.content || '',
                        item.mastery || 0,
                        item.gains || '',
                        new Date(item.timestamp).toLocaleString()
                    ]);
                    break;
                case 'reading':
                    headers = ['日期', '书籍标题', '阅读进度', '感悟', '推荐度', '创建时间'];
                    rows = data.map(item => [
                        item.date || '',
                        item.title || '',
                        item.progress || '',
                        item.reflection || '',
                        item.rating || 0,
                        new Date(item.timestamp).toLocaleString()
                    ]);
                    break;
                case 'emotion':
                    headers = ['日期', '情绪', '强度', '触发事件', '调节方法', '创建时间'];
                    rows = data.map(item => [
                        item.date || '',
                        item.emotion || '',
                        item.intensity || 0,
                        item.trigger || '',
                        item.regulation || '',
                        new Date(item.timestamp).toLocaleString()
                    ]);
                    break;
            }
            
            const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            return '\uFEFF' + csvContent; // 添加BOM以支持中文
        }

        // 转换为TXT格式
        function convertToTXT(data, moduleType) {
            let content = '';
            
            switch(moduleType) {
                case 'plan':
                    content = '=== 计划数据 ===\n\n';
                    data.forEach((item, index) => {
                        content += `${index + 1}. 计划记录\n`;
                        content += `   日期: ${item.date || ''}\n`;
                        content += `   主要目标: ${item.mainGoals || ''}\n`;
                        content += `   详细计划: ${item.detailPlan || ''}\n`;
                        content += `   预期完成度: ${item.expectedCompletion || 0}/5\n`;
                        content += `   创建时间: ${new Date(item.timestamp).toLocaleString()}\n\n`;
                    });
                    break;
                case 'exercise':
                    content = '=== 运动数据 ===\n\n';
                    data.forEach((item, index) => {
                        content += `${index + 1}. 运动记录\n`;
                        content += `   日期: ${item.date || ''}\n`;
                        content += `   运动类型: ${item.type || ''}\n`;
                        content += `   时长: ${item.duration || 0}分钟\n`;
                        content += `   强度: ${item.intensity || 0}/5\n`;
                        content += `   感受: ${item.feeling || ''}\n`;
                        content += `   创建时间: ${new Date(item.timestamp).toLocaleString()}\n\n`;
                    });
                    break;
                case 'study':
                    content = '=== 学习数据 ===\n\n';
                    data.forEach((item, index) => {
                        content += `${index + 1}. 学习记录\n`;
                        content += `   日期: ${item.date || ''}\n`;
                        content += `   学习主题: ${item.topics ? item.topics.map(t => t.name).join(', ') : (item.subject || '')}\n`;
                        content += `   总时长: ${item.totalDuration || item.duration || 0}分钟\n`;
                        content += `   学习内容: ${item.content || ''}\n`;
                        content += `   掌握度: ${item.mastery || 0}/5\n`;
                        content += `   收获: ${item.gains || ''}\n`;
                        content += `   创建时间: ${new Date(item.timestamp).toLocaleString()}\n\n`;
                    });
                    break;
                case 'reading':
                    content = '=== 阅读数据 ===\n\n';
                    data.forEach((item, index) => {
                        content += `${index + 1}. 阅读记录\n`;
                        content += `   日期: ${item.date || ''}\n`;
                        content += `   书籍标题: ${item.title || ''}\n`;
                        content += `   阅读进度: ${item.progress || ''}\n`;
                        content += `   感悟: ${item.reflection || ''}\n`;
                        content += `   推荐度: ${item.rating || 0}/5\n`;
                        content += `   创建时间: ${new Date(item.timestamp).toLocaleString()}\n\n`;
                    });
                    break;
                case 'emotion':
                    content = '=== 情绪数据 ===\n\n';
                    data.forEach((item, index) => {
                        content += `${index + 1}. 情绪记录\n`;
                        content += `   日期: ${item.date || ''}\n`;
                        content += `   情绪: ${item.emotion || ''}\n`;
                        content += `   强度: ${item.intensity || 0}/5\n`;
                        content += `   触发事件: ${item.trigger || ''}\n`;
                        content += `   调节方法: ${item.regulation || ''}\n`;
                        content += `   创建时间: ${new Date(item.timestamp).toLocaleString()}\n\n`;
                    });
                    break;
            }
            
            return content;
        }

        // 导出模块为图片
        function exportModuleAsImage(moduleType) {
            const moduleElement = document.getElementById(moduleType);
            if (!moduleElement) {
                alert('模块不存在！');
                return;
            }
            
            // 使用html2canvas导出模块为图片
            html2canvas(moduleElement, {
                backgroundColor: '#ffffff',
                scale: 3, // 提高分辨率
                useCORS: true,
                allowTaint: false,
                foreignObjectRendering: false,
                logging: false,
                width: moduleElement.scrollWidth,
                height: moduleElement.scrollHeight,
                dpi: 300, // 设置DPI为300
                pixelRatio: 3 // 提高像素比
            }).then(canvas => {
                const link = document.createElement('a');
                const dateStr = new Date().toLocaleDateString().replace(/\//g, '-');
                link.download = `${getModuleName(moduleType)}_${dateStr}.png`;
                link.href = canvas.toDataURL();
                link.click();
                alert(`${getModuleName(moduleType)}已导出为图片！`);
            }).catch(error => {
                console.error('导出失败:', error);
                alert('导出失败，请重试！');
            });
        }

        // 获取模块中文名称
        function getModuleName(moduleType) {
            const names = {
                'plan': '计划模块',
                'exercise': '运动模块',
                'study': '学习模块',
                'reading': '阅读模块',
                'emotion': '情绪模块'
            };
            return names[moduleType] || moduleType;
        }

        // 下载文件到默认下载目录
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert(`${filename} 已成功导出到下载文件夹！`);
        }

        // 用户姓名管理
        function initializeUserName() {
            const savedName = localStorage.getItem('userName');
            if (savedName) {
                document.getElementById('userNameDisplay').textContent = savedName + '的';
                document.getElementById('userName').value = savedName;
            }
        }

        function updateUserName() {
            const nameInput = document.getElementById('userName');
            const name = nameInput.value.trim();
            
            if (name) {
                document.getElementById('userNameDisplay').textContent = name + '的';
                localStorage.setItem('userName', name);
                alert('姓名已更新！');
                // 更新后自动隐藏输入框
                document.getElementById('userNameSection').style.display = 'none';
            } else {
                alert('请输入有效的姓名！');
            }
        }

        // 切换用户姓名输入框的显示/隐藏
        function toggleUserNameSection() {
            const section = document.getElementById('userNameSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                // 聚焦到输入框
                document.getElementById('userName').focus();
            } else {
                section.style.display = 'none';
            }
        }

        // 每日励志语录
        const dailyQuotes = [
            "今天的努力，是明天成功的基石。",
            "每一次进步，都是对昨天的超越。",
            "成长不是一蹴而就，而是日积月累的坚持。",
            "相信自己，你比想象中更强大。",
            "困难是成长路上的垫脚石，而非绊脚石。",
            "今天的你，要比昨天的你更优秀一点点。",
            "梦想不会逃跑，会逃跑的永远都是自己。",
            "每一个不曾起舞的日子，都是对生命的辜负。",
            "成功的秘诀在于坚持自己的梦想。",
            "路虽远，行则将至；事虽难，做则必成。",
            "不要等待机会，而要创造机会。",
            "今天的汗水，是明天微笑的理由。",
            "每一次挫折，都是成长的机会。",
            "保持初心，方得始终。",
            "努力不一定成功，但放弃一定失败。",
            "时间会证明，所有的努力都不会白费。",
            "成长的路上，感谢每一个坚持的自己。",
            "今天的选择，决定明天的你。",
            "勇敢面对挑战，你会发现自己的无限可能。",
            "每一天都是新的开始，每一刻都充满希望。",
            "成功不是终点，而是不断前进的过程。",
            "相信过程，享受成长的每一个瞬间。",
            "今天的学习，是明天智慧的积累。",
            "坚持做对的事，时间会给你最好的答案。",
            "每一次努力，都让你离梦想更近一步。",
            "成长的意义，在于成为更好的自己。",
            "今天的付出，是对未来最好的投资。",
            "保持好奇心，世界会为你展现更多精彩。",
            "每一个微小的进步，都值得被庆祝。",
            "勇敢追求梦想，让生命绽放光彩。"
        ];

        function updateDailyQuote() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quoteIndex = dayOfYear % dailyQuotes.length;
            
            document.getElementById('dailyQuote').textContent = dailyQuotes[quoteIndex];
        }

        // 图片模态框功能
        function openImageModal(imageId, module) {
            console.log('openImageModal called with:', imageId, module); // 调试日志
            
            // 使用统一的数据获取方式
            const moduleImages = getModuleImages(module);
            console.log('moduleImages:', moduleImages); // 调试日志
            
            const imageInfo = moduleImages[imageId];
            console.log('imageInfo:', imageInfo); // 调试日志
            
            if (!imageInfo) {
                console.error('Image not found:', imageId, module);
                return;
            }

            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalDescription = document.getElementById('modalDescription');
            const modalTags = document.getElementById('modalTags');
            const modalTimestamp = document.getElementById('modalTimestamp');

            if (!modal || !modalImage || !modalDescription || !modalTags || !modalTimestamp) {
                console.error('Modal elements not found');
                return;
            }

            modalImage.src = imageInfo.url;
            modalDescription.value = imageInfo.description || '';
            modalTags.value = imageInfo.tags ? imageInfo.tags.join(', ') : '';
            modalTimestamp.textContent = new Date(imageInfo.timestamp).toLocaleString('zh-CN');

            // 存储当前编辑的图片信息
            modalImage.dataset.imageId = imageId;
            modalImage.dataset.module = module;

            // 加载当前图片的标签到标签系统
            currentImageTags = imageInfo && imageInfo.tags ? [...imageInfo.tags] : [];
            updateCurrentTagsDisplay();
            updatePopularTags();

            modal.style.display = 'block';
            modal.classList.add('show');
            console.log('Modal should be visible now'); // 调试日志
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // 等待动画完成
            // 清空当前标签
            currentImageTags = [];
        }

        function saveImageInfo() {
            const modalImage = document.getElementById('modalImage');
            const imageId = modalImage.dataset.imageId;
            const module = modalImage.dataset.module;
            const description = document.getElementById('modalDescription').value;
            
            if (imageId && module) {
                // 直接更新imageData对象
                if (imageData[module] && imageData[module][imageId]) {
                    imageData[module][imageId].description = description;
                    imageData[module][imageId].tags = [...currentImageTags];
                    
                    // 保存到localStorage - 使用统一的imageData键
                    localStorage.setItem('imageData', JSON.stringify(imageData));
                    
                    // 更新全局标签集合
                    currentImageTags.forEach(tag => allTags.add(tag));
                    
                    // 刷新显示
                    const previewContainer = document.getElementById(`${module}-image-preview`);
                    if (previewContainer) {
                        displayStoredImages(module, previewContainer);
                    }
                    
                    // 如果时间轴页面打开，也刷新时间轴
                    if (document.getElementById('timeline').style.display !== 'none') {
                        loadTimeline();
                        loadTagManagement();
                    }
                    
                    closeImageModal();
                }
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeImageModal();
            }
        }

        // 时间轴相关函数
        function loadTimeline() {
            const timelineContent = document.getElementById('timelineContent');
            const allImages = getAllImagesWithTimestamp();
            
            if (allImages.length === 0) {
                timelineContent.innerHTML = `
                    <div class="timeline-empty">
                        <div class="empty-icon">📷</div>
                        <h3>还没有图片记录</h3>
                        <p>开始在各个模块中上传图片，记录你的成长历程吧！</p>
                    </div>
                `;
                updateTimelineStats(0, 0);
                return;
            }

            // 按日期分组
            const groupedImages = groupImagesByDate(allImages);
            
            // 生成时间轴HTML
            let timelineHTML = '';
            Object.keys(groupedImages).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const images = groupedImages[date];
                const dateObj = new Date(date);
                const dayOfMonth = dateObj.getDate();
                const monthDay = `${dateObj.getMonth() + 1}/${dayOfMonth}`;
                
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-date">
                            <div class="timeline-date-circle">${dayOfMonth}</div>
                            <div class="timeline-date-text">${monthDay}</div>
                        </div>
                        <div class="timeline-content-wrapper">
                            <div class="timeline-images">
                                ${images.map(img => `
                                    <div class="timeline-image-item" onclick="openImageModal('${img.id}', '${img.module}')">
                                        <img src="${img.url}" alt="${img.name}">
                                        <div class="timeline-image-overlay">
                                            <div class="timeline-image-module">${getModuleDisplayName(img.module)}</div>
                                            <div class="timeline-image-desc">${img.description || '点击添加描述'}</div>
                                            ${img.tags && img.tags.length > 0 ? `
                                                <div class="timeline-image-tags">
                                                    ${img.tags.map(tag => `<span class="timeline-tag">${tag}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            timelineContent.innerHTML = timelineHTML;
            updateTimelineStats(allImages.length, allImages.length);
        }

        function getAllImagesWithTimestamp() {
            const allImages = [];
            const modules = ['plan', 'exercise', 'study', 'reading', 'emotion'];
            
            modules.forEach(module => {
                const moduleImages = getModuleImages(module);
                Object.entries(moduleImages).forEach(([id, imageData]) => {
                    allImages.push({
                        id: id,
                        module: module,
                        url: imageData.url,
                        name: imageData.name,
                        timestamp: imageData.timestamp || Date.now(),
                        description: imageData.description || '',
                        tags: imageData.tags || []
                    });
                });
            });
            
            return allImages.sort((a, b) => b.timestamp - a.timestamp);
        }

        function groupImagesByDate(images) {
            const grouped = {};
            images.forEach(img => {
                const date = new Date(img.timestamp).toDateString();
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(img);
            });
            return grouped;
        }

        function getModuleDisplayName(module) {
            const names = {
                plan: '📅 计划',
                exercise: '🏃‍♂️ 运动',
                study: '📚 学习',
                reading: '📖 阅读',
                emotion: '😊 情绪'
            };
            return names[module] || module;
        }

        function filterTimeline() {
            const timeRange = document.getElementById('timelineRange').value;
            const moduleFilter = document.getElementById('moduleFilter').value;
            const tagSearch = document.getElementById('tagSearch').value.toLowerCase();
            
            let allImages = getAllImagesWithTimestamp();
            
            // 时间范围筛选
            if (timeRange !== 'all') {
                const days = parseInt(timeRange);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                allImages = allImages.filter(img => new Date(img.timestamp) >= cutoffDate);
            }
            
            // 模块筛选
            if (moduleFilter !== 'all') {
                allImages = allImages.filter(img => img.module === moduleFilter);
            }
            
            // 标签搜索
            if (tagSearch) {
                allImages = allImages.filter(img => {
                    const description = (img.description || '').toLowerCase();
                    const tags = (img.tags || []).join(' ').toLowerCase();
                    return description.includes(tagSearch) || tags.includes(tagSearch);
                });
            }
            
            // 更新显示
            const timelineContent = document.getElementById('timelineContent');
            if (allImages.length === 0) {
                timelineContent.innerHTML = `
                    <div class="timeline-empty">
                        <div class="empty-icon">🔍</div>
                        <h3>没有找到匹配的图片</h3>
                        <p>尝试调整筛选条件或搜索关键词</p>
                    </div>
                `;
                updateTimelineStats(getAllImagesWithTimestamp().length, 0);
                return;
            }
            
            // 按日期分组并显示
            const groupedImages = groupImagesByDate(allImages);
            let timelineHTML = '';
            Object.keys(groupedImages).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const images = groupedImages[date];
                const dateObj = new Date(date);
                const dayOfMonth = dateObj.getDate();
                const monthDay = `${dateObj.getMonth() + 1}/${dayOfMonth}`;
                
                timelineHTML += `
                    <div class="timeline-item">
                        <div class="timeline-date">
                            <div class="timeline-date-circle">${dayOfMonth}</div>
                            <div class="timeline-date-text">${monthDay}</div>
                        </div>
                        <div class="timeline-content-wrapper">
                            <div class="timeline-images">
                                ${images.map(img => `
                                    <div class="timeline-image-item" onclick="openImageModal('${img.id}', '${img.module}')">
                                        <img src="${img.url}" alt="${img.name}">
                                        <div class="timeline-image-overlay">
                                            <div class="timeline-image-module">${getModuleDisplayName(img.module)}</div>
                                            <div class="timeline-image-desc">${img.description || '点击添加描述'}</div>
                                            ${img.tags && img.tags.length > 0 ? `
                                                <div class="timeline-image-tags">
                                                    ${img.tags.map(tag => `<span class="timeline-tag">${tag}</span>`).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            timelineContent.innerHTML = timelineHTML;
            updateTimelineStats(getAllImagesWithTimestamp().length, allImages.length);
        }

        function updateTimelineStats(total, filtered) {
            document.getElementById('totalImages').textContent = total;
            document.getElementById('filteredImages').textContent = filtered;
        }

        // 修改showModule函数以支持时间轴和数据面板
        const originalShowModule = showModule;

        // 标签系统相关函数
        let currentImageTags = [];
        let allTags = new Set();

        function initTagSystem() {
            const tagInput = document.getElementById('modalTags');
            if (tagInput) {
                tagInput.addEventListener('keydown', handleTagInput);
                tagInput.addEventListener('input', showTagSuggestions);
                tagInput.addEventListener('blur', hideTagSuggestions);
            }
            loadAllTags();
        }

        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const tagValue = event.target.value.trim();
                if (tagValue && !currentImageTags.includes(tagValue)) {
                    addTag(tagValue);
                    event.target.value = '';
                    hideTagSuggestions();
                }
            }
        }

        function addTag(tagName) {
            if (!currentImageTags.includes(tagName)) {
                currentImageTags.push(tagName);
                allTags.add(tagName);
                updateCurrentTagsDisplay();
                updatePopularTags();
            }
        }

        function removeTag(tagName) {
            const index = currentImageTags.indexOf(tagName);
            if (index > -1) {
                currentImageTags.splice(index, 1);
                updateCurrentTagsDisplay();
            }
        }

        function updateCurrentTagsDisplay() {
            const container = document.getElementById('currentTags');
            if (!container) return;
            
            container.innerHTML = currentImageTags.map(tag => `
                <span class="tag-item">
                    ${tag}
                    <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
                </span>
            `).join('');
        }

        function showTagSuggestions(event) {
            const input = event.target.value.toLowerCase();
            if (input.length < 1) {
                hideTagSuggestions();
                return;
            }

            const suggestions = Array.from(allTags).filter(tag => 
                tag.toLowerCase().includes(input) && !currentImageTags.includes(tag)
            );

            const suggestionsContainer = document.getElementById('tagSuggestions');
            if (suggestions.length > 0) {
                suggestionsContainer.innerHTML = suggestions.slice(0, 5).map(tag => `
                    <div class="tag-suggestion-item" onclick="selectSuggestion('${tag}')">${tag}</div>
                `).join('');
                suggestionsContainer.style.display = 'block';
            } else {
                hideTagSuggestions();
            }
        }

        function selectSuggestion(tagName) {
            addTag(tagName);
            document.getElementById('modalTags').value = '';
            hideTagSuggestions();
        }

        function hideTagSuggestions() {
            setTimeout(() => {
                const suggestionsContainer = document.getElementById('tagSuggestions');
                if (suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            }, 200);
        }

        function loadAllTags() {
            const modules = ['plan', 'exercise', 'study', 'reading', 'emotion'];
            allTags.clear();
            
            modules.forEach(module => {
                const moduleImages = getModuleImages(module);
                Object.values(moduleImages).forEach(imageData => {
                    if (imageData.tags && Array.isArray(imageData.tags)) {
                        imageData.tags.forEach(tag => allTags.add(tag));
                    }
                });
            });
            
            updatePopularTags();
        }

        function updatePopularTags() {
            const tagCounts = getTagCounts();
            const popularTagsContainer = document.getElementById('popularTags');
            if (!popularTagsContainer) return;
            
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            popularTagsContainer.innerHTML = sortedTags.map(([tag, count]) => `
                <span class="popular-tag" onclick="addTag('${tag}')">${tag} (${count})</span>
            `).join('');
        }

        function getTagCounts() {
            const tagCounts = {};
            const modules = ['plan', 'exercise', 'study', 'reading', 'emotion'];
            
            modules.forEach(module => {
                const moduleImages = getModuleImages(module);
                Object.values(moduleImages).forEach(imageData => {
                    if (imageData.tags && Array.isArray(imageData.tags)) {
                        imageData.tags.forEach(tag => {
                            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                        });
                    }
                });
            });
            
            return tagCounts;
        }

        function loadTagManagement() {
            const tagCounts = getTagCounts();
            const totalTags = Object.keys(tagCounts).length;
            const taggedImages = getAllImagesWithTimestamp().filter(img => img.tags && img.tags.length > 0).length;
            const mostUsedCount = Math.max(...Object.values(tagCounts), 0);
            
            // 更新统计数据
            document.getElementById('totalTagsCount').textContent = totalTags;
            document.getElementById('taggedImagesCount').textContent = taggedImages;
            document.getElementById('mostUsedTagCount').textContent = mostUsedCount;
            
            // 生成标签云
            const tagCloud = document.getElementById('tagCloud');
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            tagCloud.innerHTML = sortedTags.map(([tag, count]) => `
                <div class="tag-cloud-item" onclick="filterByTag('${tag}')">
                    ${tag}
                    <span class="tag-count">${count}</span>
                </div>
            `).join('');
        }

        function filterByTag(tagName) {
            document.getElementById('tagSearch').value = tagName;
            filterTimeline();
        }

        // 修改openImageModal函数以支持标签系统
        // 已经在上面的openImageModal函数中集成了标签系统支持

        // 修改saveImageInfo函数以保存标签
        // 已经在上面的saveImageInfo函数中集成了标签保存功能

        // 图片统计面板功能
        function loadImageStats() {
            const allImages = getAllImagesWithTimestamp();
            
            // 更新基础统计
            updateBasicImageStats(allImages);
            
            // 更新图片增长统计面板
            updateImageGrowthPanel(allImages);
        }

        function updateBasicImageStats(allImages) {
            const totalImages = allImages.length;
            const allTags = new Set();
            
            allImages.forEach(img => {
                if (img.tags) {
                    img.tags.forEach(tag => allTags.add(tag));
                }
            });

            // 计算本月新增图片
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const monthlyImages = allImages.filter(img => {
                const imgDate = new Date(img.timestamp);
                const imgMonth = imgDate.getFullYear() + '-' + String(imgDate.getMonth() + 1).padStart(2, '0');
                return imgMonth === currentMonth;
            }).length;

            // 更新统计卡片
            const imageCountElement = document.querySelector('.stat-card:nth-child(4) .stat-number');
            const tagCountElement = document.querySelector('.stat-card:nth-child(5) .stat-number');
            const monthlyCountElement = document.querySelector('.stat-card:nth-child(6) .stat-number');

            if (imageCountElement) imageCountElement.textContent = totalImages;
            if (tagCountElement) tagCountElement.textContent = allTags.size;
            if (monthlyCountElement) monthlyCountElement.textContent = monthlyImages;
        }

        function updateImageGrowthPanel(allImages) {
            updateModuleDistribution(allImages);
            updateMonthlyTrend(allImages);
            updateTopTags(allImages);
            updateTimeDistribution(allImages);
        }

        function updateModuleDistribution(allImages) {
            const moduleStats = {};
            
            allImages.forEach(img => {
                const module = img.module || 'unknown';
                moduleStats[module] = (moduleStats[module] || 0) + 1;
            });

            const container = document.querySelector('.module-distribution');
            if (!container) return;

            container.innerHTML = '';
            
            Object.entries(moduleStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([module, count]) => {
                    const item = document.createElement('div');
                    item.className = 'module-item';
                    item.innerHTML = `
                        <span class="module-name">${getModuleDisplayName(module)}</span>
                        <span class="module-count">${count}</span>
                    `;
                    container.appendChild(item);
                });
        }

        function updateMonthlyTrend(allImages) {
            const monthlyStats = {};
            
            allImages.forEach(img => {
                const date = new Date(img.timestamp);
                const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                monthlyStats[monthKey] = (monthlyStats[monthKey] || 0) + 1;
            });

            const container = document.querySelector('.monthly-trend');
            if (!container) return;

            container.innerHTML = '';
            
            // 获取最近6个月的数据
            const months = Object.keys(monthlyStats).sort().slice(-6);
            
            months.forEach(month => {
                const item = document.createElement('div');
                item.className = 'trend-item';
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('zh-CN', { month: 'short' });
                
                item.innerHTML = `
                    <span class="trend-month">${monthName}</span>
                    <span class="trend-count">${monthlyStats[month]}</span>
                `;
                container.appendChild(item);
            });
        }

        function updateTopTags(allImages) {
            const tagCounts = getTagCounts(allImages);
            const container = document.querySelector('.top-tags-list');
            if (!container) return;

            container.innerHTML = '';
            
            Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .forEach(([tag, count]) => {
                    const item = document.createElement('div');
                    item.className = 'top-tag-item';
                    item.onclick = () => filterByTag(tag);
                    item.innerHTML = `
                        <span class="tag-name">${tag}</span>
                        <span class="tag-usage-count">${count}</span>
                    `;
                    container.appendChild(item);
                });
        }

        function updateTimeDistribution(allImages) {
            const timeSlots = {
                '早晨 (6-12)': 0,
                '下午 (12-18)': 0,
                '晚上 (18-24)': 0,
                '深夜 (0-6)': 0
            };

            allImages.forEach(img => {
                const hour = new Date(img.timestamp).getHours();
                if (hour >= 6 && hour < 12) {
                    timeSlots['早晨 (6-12)']++;
                } else if (hour >= 12 && hour < 18) {
                    timeSlots['下午 (12-18)']++;
                } else if (hour >= 18 && hour < 24) {
                    timeSlots['晚上 (18-24)']++;
                } else {
                    timeSlots['深夜 (0-6)']++;
                }
            });

            const container = document.querySelector('.time-distribution');
            if (!container) return;

            container.innerHTML = '';
            
            Object.entries(timeSlots).forEach(([timeLabel, count]) => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.innerHTML = `
                    <div class="time-label">${timeLabel}</div>
                    <div class="time-count">${count}</div>
                `;
                container.appendChild(slot);
            });
        }

        // 修改showModule函数，添加数据面板的图片统计加载
        showModule = function(module) {
            originalShowModule(module);
            
            if (module === 'timeline') {
                setTimeout(() => {
                    loadTimeline();
                    loadTagManagement();
                }, 100);
            } else if (module === 'data') {
                setTimeout(() => {
                    loadImageStats();
                }, 100);
            } else if (module === 'annual-summary') {
                setTimeout(() => {
                    initAnnualSummary();
                }, 100);
            }
        };

        // ==================== 年度总结功能 ====================
        
        // 初始化年度总结
        function initAnnualSummary() {
            populateYearSelector();
            
            // 检查是否是12月31日，自动生成年度总结
            const today = new Date();
            if (today.getMonth() === 11 && today.getDate() === 31) {
                showAnnualSummaryNotification();
            }
        }

        // 填充年份选择器
        function populateYearSelector() {
            const yearSelect = document.getElementById('summaryYear');
            if (!yearSelect) return;

            const currentYear = new Date().getFullYear();
            const availableYears = getAvailableYears();
            
            yearSelect.innerHTML = '<option value="">请选择年份</option>';
            
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
        }

        // 获取有数据的年份
        function getAvailableYears() {
            const years = new Set();
            
            // 遍历所有数据，提取年份
            Object.values(growthData).forEach(dataArray => {
                if (Array.isArray(dataArray)) {
                    dataArray.forEach(item => {
                        if (item.timestamp || item.date) {
                            const date = new Date(item.timestamp || item.date);
                            if (!isNaN(date.getTime())) {
                                years.add(date.getFullYear());
                            }
                        }
                    });
                }
            });

            return Array.from(years).sort((a, b) => b - a);
        }

        // 生成年度总结
        function generateAnnualSummary() {
            const selectedYear = document.getElementById('summaryYear').value;
            if (!selectedYear) {
                alert('请先选择年份');
                return;
            }

            const yearData = getYearData(parseInt(selectedYear));
            const summaryContent = createAnnualSummaryContent(yearData, selectedYear);
            
            document.getElementById('annualSummaryContent').innerHTML = summaryContent;
        }

        // 获取指定年份的数据
        function getYearData(year) {
            const yearData = {
                plans: [],
                exercises: [],
                studies: [],
                readings: [],
                emotions: []
            };

            Object.keys(growthData).forEach(key => {
                if (Array.isArray(growthData[key])) {
                    yearData[key] = growthData[key].filter(item => {
                        const date = new Date(item.timestamp || item.date);
                        return date.getFullYear() === year;
                    });
                }
            });

            return yearData;
        }

        // 创建年度总结内容
        function createAnnualSummaryContent(yearData, year) {
            const keywords = analyzeKeywords(yearData);
            const statistics = calculateYearStatistics(yearData);
            const achievements = analyzeAchievements(yearData);
            const growth = analyzeGrowthTrajectory(yearData);

            return `
                <div class="annual-summary-report">
                    <div class="summary-header">
                        <h3>🎊 ${year}年度成长总结</h3>
                        <p class="summary-subtitle">回顾这一年的成长足迹，见证每一份努力与收获</p>
                    </div>

                    <!-- 关键词云 -->
                    <div class="summary-section">
                        <h4>🔥 年度关键词</h4>
                        <div class="keywords-cloud">
                            ${keywords.map(kw => `
                                <span class="keyword-tag" style="font-size: ${Math.min(24, 12 + kw.count * 2)}px">
                                    ${kw.word} (${kw.count})
                                </span>
                            `).join('')}
                        </div>
                        <p class="keywords-insight">这些词汇最能代表你${year}年的成长主题</p>
                    </div>

                    <!-- 数据统计 -->
                    <div class="summary-section">
                        <h4>📊 年度数据一览</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${statistics.totalDays}</div>
                                <div class="stat-label">记录天数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${statistics.exerciseHours}h</div>
                                <div class="stat-label">运动时长</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${statistics.studyHours}h</div>
                                <div class="stat-label">学习时长</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${statistics.readingHours}h</div>
                                <div class="stat-label">阅读时长</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${statistics.booksRead}</div>
                                <div class="stat-label">阅读书籍</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${statistics.avgEmotion.toFixed(1)}</div>
                                <div class="stat-label">平均情绪分</div>
                            </div>
                        </div>
                    </div>

                    <!-- 成长轨迹 -->
                    <div class="summary-section">
                        <h4>📈 成长轨迹</h4>
                        <div class="growth-timeline">
                            ${growth.map(milestone => `
                                <div class="milestone">
                                    <div class="milestone-date">${milestone.month}月</div>
                                    <div class="milestone-content">
                                        <h5>${milestone.title}</h5>
                                        <p>${milestone.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- 成就解锁 -->
                    <div class="summary-section">
                        <h4>🏆 成就解锁</h4>
                        <div class="achievements-grid">
                            ${achievements.map(achievement => `
                                <div class="achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}">
                                    <div class="achievement-icon">${achievement.icon}</div>
                                    <div class="achievement-title">${achievement.title}</div>
                                    <div class="achievement-desc">${achievement.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- 年度寄语 -->
                    <div class="summary-section">
                        <h4>💌 年度寄语</h4>
                        <div class="annual-message">
                            <p>${generateAnnualMessage(statistics, year)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // 关键词分析
        function analyzeKeywords(yearData) {
            const wordCount = {};
            const stopWords = new Set(['的', '了', '在', '是', '我', '有', '和', '就', '不', '人', '都', '一', '一个', '上', '也', '很', '到', '说', '要', '去', '你', '会', '着', '没有', '看', '好', '自己', '这', '那', '里', '就是', '还', '把', '比', '或者']);

            // 提取所有文本内容
            const allTexts = [];
            
            Object.values(yearData).forEach(dataArray => {
                dataArray.forEach(item => {
                    // 提取各种文本字段
                    const textFields = ['goals', 'plan', 'content', 'subject', 'type', 'book', 'author', 'notes', 'trigger', 'regulation', 'description'];
                    textFields.forEach(field => {
                        if (item[field] && typeof item[field] === 'string') {
                            allTexts.push(item[field]);
                        }
                    });
                    
                    // 处理学习记录的多主题结构
                    if (item.topics && Array.isArray(item.topics)) {
                        item.topics.forEach(topic => {
                            if (topic.subject) allTexts.push(topic.subject);
                            if (topic.content) allTexts.push(topic.content);
                        });
                    }
                });
            });

            // 分词并统计
            allTexts.forEach(text => {
                // 简单的中文分词（按标点符号和空格分割）
                const words = text.match(/[\u4e00-\u9fa5]+/g) || [];
                words.forEach(word => {
                    if (word.length >= 2 && !stopWords.has(word)) {
                        wordCount[word] = (wordCount[word] || 0) + 1;
                    }
                });
            });

            // 返回前20个高频词
            return Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([word, count]) => ({ word, count }));
        }

        // 计算年度统计
        function calculateYearStatistics(yearData) {
            const stats = {
                totalDays: 0,
                exerciseHours: 0,
                studyHours: 0,
                readingHours: 0,
                booksRead: 0,
                avgEmotion: 0
            };

            // 计算记录天数
            const allDates = new Set();
            Object.values(yearData).forEach(dataArray => {
                dataArray.forEach(item => {
                    const date = new Date(item.timestamp || item.date);
                    allDates.add(date.toDateString());
                });
            });
            stats.totalDays = allDates.size;

            // 运动时长
            stats.exerciseHours = Math.round(yearData.exercises.reduce((sum, ex) => sum + (ex.duration || 0), 0) / 60);

            // 学习时长
            stats.studyHours = Math.round(yearData.studies.reduce((sum, study) => {
                if (study.topics && Array.isArray(study.topics)) {
                    return sum + (study.totalDuration || 0);
                }
                return sum + (study.duration || 0);
            }, 0) / 60);

            // 阅读时长和书籍数
            const uniqueBooks = new Set();
            stats.readingHours = Math.round(yearData.readings.reduce((sum, reading) => {
                if (reading.book) uniqueBooks.add(reading.book);
                const match = (reading.progress || '').match(/(\d+)分钟/);
                return sum + (match ? parseInt(match[1]) : 0);
            }, 0) / 60);
            stats.booksRead = uniqueBooks.size;

            // 平均情绪分
            if (yearData.emotions.length > 0) {
                stats.avgEmotion = yearData.emotions.reduce((sum, emotion) => sum + (emotion.intensity || 0), 0) / yearData.emotions.length;
            }

            return stats;
        }

        // 分析成就
        function analyzeAchievements(yearData) {
            const achievements = [
                {
                    icon: '🏃‍♂️',
                    title: '运动达人',
                    description: '累计运动超过100小时',
                    unlocked: yearData.exercises.reduce((sum, ex) => sum + (ex.duration || 0), 0) >= 6000
                },
                {
                    icon: '📚',
                    title: '学习之星',
                    description: '累计学习超过200小时',
                    unlocked: yearData.studies.reduce((sum, study) => {
                        if (study.topics && Array.isArray(study.topics)) {
                            return sum + (study.totalDuration || 0);
                        }
                        return sum + (study.duration || 0);
                    }, 0) >= 12000
                },
                {
                    icon: '📖',
                    title: '阅读爱好者',
                    description: '阅读超过20本书',
                    unlocked: new Set(yearData.readings.map(r => r.book).filter(Boolean)).size >= 20
                },
                {
                    icon: '😊',
                    title: '情绪管理师',
                    description: '平均情绪分超过7分',
                    unlocked: yearData.emotions.length > 0 && 
                             yearData.emotions.reduce((sum, e) => sum + (e.intensity || 0), 0) / yearData.emotions.length >= 7
                },
                {
                    icon: '📅',
                    title: '坚持不懈',
                    description: '连续记录超过100天',
                    unlocked: new Set(Object.values(yearData).flat().map(item => {
                        const date = new Date(item.timestamp || item.date);
                        return date.toDateString();
                    })).size >= 100
                },
                {
                    icon: '🎯',
                    title: '目标达成者',
                    description: '完成超过80%的计划',
                    unlocked: yearData.plans.length > 0 && 
                             yearData.plans.filter(p => p.completed).length / yearData.plans.length >= 0.8
                }
            ];

            return achievements;
        }

        // 分析成长轨迹
        function analyzeGrowthTrajectory(yearData) {
            const monthlyData = {};
            
            // 按月份组织数据
            Object.values(yearData).forEach(dataArray => {
                dataArray.forEach(item => {
                    const date = new Date(item.timestamp || item.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            plans: 0,
                            exercises: 0,
                            studies: 0,
                            readings: 0,
                            emotions: 0
                        };
                    }
                    
                    // 根据数据类型增加计数
                    if (yearData.plans.includes(item)) monthlyData[monthKey].plans++;
                    if (yearData.exercises.includes(item)) monthlyData[monthKey].exercises++;
                    if (yearData.studies.includes(item)) monthlyData[monthKey].studies++;
                    if (yearData.readings.includes(item)) monthlyData[monthKey].readings++;
                    if (yearData.emotions.includes(item)) monthlyData[monthKey].emotions++;
                });
            });

            // 生成成长里程碑
            const milestones = [];
            const sortedMonths = Object.keys(monthlyData).sort();
            
            sortedMonths.forEach((monthKey, index) => {
                const [year, month] = monthKey.split('-');
                const data = monthlyData[monthKey];
                const total = Object.values(data).reduce((sum, count) => sum + count, 0);
                
                if (total > 0) {
                    let title = '';
                    let description = '';
                    
                    if (index === 0) {
                        title = '开启成长之旅';
                        description = `开始记录成长轨迹，本月共记录${total}条数据`;
                    } else if (index === sortedMonths.length - 1) {
                        title = '持续精进';
                        description = `坚持到年末，本月记录${total}条数据`;
                    } else {
                        const maxType = Object.entries(data).reduce((max, [type, count]) => 
                            count > max.count ? { type, count } : max, { type: '', count: 0 });
                        
                        const typeNames = {
                            plans: '计划制定',
                            exercises: '运动健身',
                            studies: '学习充电',
                            readings: '阅读思考',
                            emotions: '情绪管理'
                        };
                        
                        title = `专注${typeNames[maxType.type]}`;
                        description = `本月在${typeNames[maxType.type]}方面表现突出，记录${maxType.count}次`;
                    }
                    
                    milestones.push({
                        month: parseInt(month),
                        title,
                        description
                    });
                }
            });

            return milestones.slice(0, 6); // 最多显示6个里程碑
        }

        // 生成年度寄语
        function generateAnnualMessage(statistics, year) {
            const messages = [
                `${year}年，你用${statistics.totalDays}天的坚持，书写了属于自己的成长故事。`,
                `在过去的一年里，你在运动中挥洒了${statistics.exerciseHours}小时的汗水，在学习中投入了${statistics.studyHours}小时的专注。`,
                `${statistics.booksRead}本书籍为你打开了新的世界，每一页都是成长的见证。`,
                `愿你在新的一年里，继续保持这份对成长的热爱与坚持，让每一天都成为更好的自己。`,
                `记住，成长不是一蹴而就的，而是在每一个平凡的日子里，一点一滴的积累。`
            ];

            return messages.join(' ');
        }

        // 显示年度总结通知
        function showAnnualSummaryNotification() {
            if (confirm('🎊 今天是12月31日！要不要生成你的年度总结，回顾这一年的成长轨迹？')) {
                showModule('annual-summary');
                setTimeout(() => {
                    const currentYear = new Date().getFullYear();
                    document.getElementById('summaryYear').value = currentYear;
                    generateAnnualSummary();
                }, 500);
            }
        }

        // 导出年度总结
        function exportAnnualSummary() {
            const summaryContent = document.getElementById('annualSummaryContent');
            if (!summaryContent || summaryContent.querySelector('.summary-placeholder')) {
                alert('请先生成年度总结');
                return;
            }

            // 使用html2canvas导出
            html2canvas(summaryContent, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                allowTaint: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `年度总结_${document.getElementById('summaryYear').value}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(error => {
                console.error('导出失败:', error);
                alert('导出失败，请重试');
            });
        }
    </script>
</body>
</html>
